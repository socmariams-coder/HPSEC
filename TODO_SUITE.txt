================================================================================
TODO - SUITE HPSEC
================================================================================

################################################################################
PRINCIPIS D'ARQUITECTURA
################################################################################

PRINCIPI 1: JSON COMPLET > LECTURA EXCEL
  Qualsevol canvi a la GUI que requereixi dades, verificar primer si és millor
  afegir els camps al JSON (backend) en lloc de llegir Excels (lent).

  CORRECTE:  consolidation.json conté TOTA la info → GUI llegeix 1 fitxer
  INCORRECTE: GUI llegeix N fitxers Excel per obtenir info addicional

  Motius:
  - Eficiència: 1 JSON vs N Excels (pandas)
  - Consistència: tota la info centralitzada
  - Menys dependències a la GUI

################################################################################
BUGS CONSOLIDACIÓ (hpsec_consolidate.py)
################################################################################

[x] FIXAT: Files DOC duplicades entre rèpliques (matching parcial)
    AFECTADES: 269B_SEQ (POST_O3), 270_SEQ_BP (POST_O3)
    CAUSA: El matching parcial agafava la primera coincidència, ignorant rèplica
    SOLUCIÓ: Nou algoritme de matching:
      1. Coincidència exacta (mostra_R#)
      2. Coincidència normalitzada (ignorar espais/guions)
      3. Coincidència parcial amb rèplica correcta
    NOTA: 283_SEQ continua amb problemes perquè el MasterFile és incomplet

[ ] PENDENT: 283_SEQ - MasterFile incomplet
    PROBLEMA: Falten línies 8-12 a 1-HPLC-SEQ (FR2606, FR2607, FR2608_R1...)
    IMPACTE: Consolidació no pot assignar files correctes a mostres faltants
    ACCIÓ: El tècnic ha de revisar l'equip i completar el MasterFile

[ ] BUG: Samples duplicats al JSON
    AFECTADES: 282B_SEQ, 283_SEQ, 284_SEQ_BP (NAOH_0.1MM)
    PROBLEMA: El mateix sample apareix 2 cops a consolidation.json
    CAUSA: Control samples (NaOH, MQ) apareixen múltiples cops sense distinció de bloc
    IMPACTE: Estadístiques incorrectes, comptadors inflats
    SOLUCIÓ: Implementar naming amb blocs (B1, B2) per controls que es repeteixen

[x] IMPLEMENTAT: Validació 1-HPLC-SEQ (validate_hplc_seq)
    Funció nova que verifica integritat del MasterFile:
      * EMPTY_HPLC_SEQ: Fulla buida o inexistent
      * MISSING_LINES: Line# no seqüencial (detecta línies faltants)
      * MISSING_FILES: Entrades MasterFile sense fitxer UIB
      * INCOMPLETE_FIRST_SAMPLES: Primeres mostres amb poc punts (memòria DOC esgotada)
    S'executa automàticament durant consolidate_sequence()
    Resultats guardats a consolidation.json

[x] IMPLEMENTAT: Quality check per detectar duplicats
    - generate_consolidation_summary() ara detecta:
      * DUPLICATE_ROWS (ERROR): Files compartides entre mostres diferents
      * DUPLICATE_SAMPLES (WARNING): Mateixa mostra apareix múltiples cops
    - update_consolidation_json.py també aplica el quality check
    - quality_issues array afegit al JSON per GUI
    - Errors/Warnings afegits automàticament

[x] IMPLEMENTAT: Auto-migració de formats antics
    Ara consolidate_sequence() crida migrate_single() si no troba MasterFile.
    257_SEQ i similars es migraran automàticament.

################################################################################
ACCIONS PENDENTS STRS (Tècnics)
################################################################################

[ ] 261D_SEQ_BP - Revisar dades
    PROBLEMA: La carpeta 261D_SEQ_BP conté fitxers incorrectes:
      - 261C_SEQ_v11.xlsx (pertany a 261C, no 261D)
      - 261_2_MasterFile.xlsx (no correspon a 261D)
    ACCIÓ: Verificar si existeixen dades reals per 261D_SEQ_BP
      - Si existeixen: crear MasterFile correcte (261D_MasterFile.xlsx)
      - Si no existeixen: eliminar carpeta o documentar com a buida

################################################################################
SESSIO EN CURS - 2026-01-28
################################################################################

TASCA ACTUAL: HPSEC Suite v3 (wizard basat en v1 + backend modular)

--------------------------------------------------------------------------------
HPSEC SUITE v3 - NOVA VERSIÓ
--------------------------------------------------------------------------------
Decisió: Partir de v1 (wizard 4 passos) + backend modular de v2.

FITXERS:
  - HPSEC_Suite.py     = v1 original (6530 línies, monolítica)
  - HPSEC_Suite_v2.py  = v2 (sidebar, modular però confusa)
  - HPSEC_Suite_v3.py  = v3 NOVA (wizard + modular)

ESTRUCTURA v3:
  ┌─────────────────────────────────────────────────────────────┐
  │  HPSEC Suite v3.0       [SEQ: xxx]    [Repositori] [⚙]     │
  ├─────────────────────────────────────────────────────────────┤
  │  [1. Consolidar] → [2. Calibrar] → [3. QC] → [4. Exportar] │
  ├─────────────────────────────────────────────────────────────┤
  │   [Contingut del pas actual - UI interactiva]              │
  ├─────────────────────────────────────────────────────────────┤
  │  [← Anterior]           Status                  [Següent →] │
  └─────────────────────────────────────────────────────────────┘

IMPLEMENTAT v3:
  [x] Estructura wizard 4 passos
  [x] Pas 1: Consolidar (info + progrés + botó)
  [x] Pas 2: Calibrar (info detallada + gràfic cromatograma + botons)
  [x] Pas 3: QC (taula interactiva + menú contextual, llegeix de JSON)
  [x] Pas 4: Exportar (opcions + resum + botons)
  [x] Navegació (Anterior/Següent + clic passos)
  [x] Detecció automàtica última SEQ
  [x] Usa backend modular (hpsec_config, hpsec_consolidate, etc.)
  [x] Pas 1: Mostra info detallada (fitxers .D, UIB, DAD, mode, orfes)
  [x] Pas 1: Resum consolidació amb estadístiques (SNR, LOD, timeouts)
  [x] Pas 1: Barres de severitat timeouts (OK/INFO/WARN/CRIT)
  [x] Pas 2: Mostra info KHP completa (origen, concentració, rèpliques)
  [x] Pas 2: Mostra resultats calibració (factor, àrea, RSD, shift)
  [x] Pas 2: Mostra qualitat (simetria, SNR, issues amb colors)
  [x] Pas 2: Gràfic cromatograma DOC amb àrea integrada + DAD 254nm
  [x] Backend integration correcta (keys calibration.factor, khp_data.*, etc.)
  [x] Generació CHECK/consolidation.json amb resum complet

PENDENT v3:
  [ ] Modal configuració (botó ⚙)
  [ ] Finestra Repositori (Calibracions + Mostres)
  [ ] Generació gràfics QAQC
  [ ] Generació PDF informe
  [ ] Testejar flux complet
  [ ] Històric KHP funcional (botó existent, implementar diàleg)
  [ ] EXPORT: Identificar run BP associat a COLUMN
      - Per FAIR data, cada export COLUMN necessita referenciar el seu run BP
      - Afegir camp "associated_bp_seq" a metadades d'exportació
      - Exemple: 283_SEQ_COLUMN -> associated_bp_seq = "283_SEQ_BP"
      - Important per traçabilitat i reproductibilitat de dades
  [ ] CONFIG: Llista injeccions control (MQ, NaOH, etc.) amb nivell duplicats diferent
      - Les injeccions control poden tenir patrons de rèplica/bloc diferents a les mostres
      - Fitxers com MQ1_UIB1B.CSV, MQ2_UIB1B.CSV no s'han de considerar orfes
      - Afegir a hpsec_config.py: CONTROL_INJECTIONS = ["MQ", "NAOH", "BLANK", ...]
      - Relacionat amb numeració de blocs als fitxers resultants
  [x] PLANNING: Planificador seqüències complet (hpsec_planner_gui.py v3.0)
      - Distingeix COLUMN vs BP
      - Tipus: SAMPLE (duplicat), KHP (duplicat), MQ (control), NaOH (neteja)
      - Timeline visual amb predicció timeouts
      - Suggeriments posició MQ/NaOH per evitar zona crítica
      - Freqüència configurable per MQ i NaOH separadament
  [ ] PLANNING: Generar configs per BP i COLUMN simultàniament
      - Per un mateix llistat de mostres, oferir config per ambdós modes
      - Les mateixes mostres s'analitzen típicament per BP i COLUMN
      - Botó "Generar ambdós" per comparar durades i timeouts
      - Export JSON amb configuració dual (COLUMN + BP)
  [ ] PLANNING: Simular seqüència òptima on timeouts cauen sempre a post-run
      - Usar timing stats de consolidation.json (pre_injection_time, interval_mean)
      - TOC_CYCLE = 77.2 min, timeout = 74 sec
      - Objectiu: calcular durada mostra i delay inicial per evitar zona crítica

--------------------------------------------------------------------------------
PIPELINE REPLICA SELECTION (2026-01-29) - COMPLETAT
--------------------------------------------------------------------------------

OBJECTIU: Implementar selecció de rèpliques post-calibració amb suport híbrid DOC/DAD

IMPLEMENTAT:
  [x] hpsec_pipeline.py - Selecció independent DOC/DAD
      - SampleResult ara té: selected_doc, selected_dad, selected (R1/R2/MIXED)
      - Comparativa entre rèpliques: Pearson, àrea, DAD quality
      - Concentracions per fracció calculades amb factor calibració
      - Paràmetres transformació per reproductibilitat

  [x] processing_summary.json - Font única de veritat
      Estructura per mostra:
        - selected_doc, selected_dad, selected
        - comparison: {pearson, area_diff_pct}
        - areas_fraction: {BioP, HS, BB, SB, LMW, total}
        - concentration_ppm, conc_fraction
        - transformation: {shift_sec, baseline_mau, factor_used, khp_source}
        - replicas: info detallada per R1, R2 incloent dad_eval

  [x] HPSEC_Suite_v3.py - GUI passiva
      - _run_review_process() ara NOMÉS llegeix de processing_summary.json
      - NO fa processament - tot ve del JSON generat per hpsec_pipeline.py
      - Mostra selecció independent (DOC/DAD) i estat MIXED
      - Guarda resultats a self.selected_replicas per exportació

FLUX FINAL:
  hpsec_pipeline.process_sequence()
    → _step_process() amb calibration_data
      → _process_sample() per cada mostra
        → Avalua rèpliques (evaluate_replica)
        → Compara (compare_replicas)
        → Selecciona millor DOC i DAD independentment
        → Calcula concentracions amb factor calibració
    → _step_export()
      → _create_export_summary() genera processing_summary.json

  HPSEC_Suite_v3.py
    → _run_review_process() llegeix processing_summary.json
    → Mostra taula amb seleccions i estat

COMMITS:
  - 14b1e80: hpsec_pipeline: Add independent DOC/DAD replica selection
  - 17b2c9d: Refactor GUI review stage to read from JSON only

--------------------------------------------------------------------------------
SUITE v3.1 - MILLORES GUI (2026-01-29)
--------------------------------------------------------------------------------

BACKEND CALIBRACIÓ:
  [x] doc_mode es llegeix correctament (DUAL/Direct/UIB)
  [x] uib_sensitivity es guarda (700/1000 ppb)
  [x] Històric filtra per doc_mode i uib_sensitivity
  [ ] Script per actualitzar doc_mode a calibracions antigues

PAS 1 - IMPORTAR (REDISSENY):
  [ ] Assignacions incorrectes: permetre correcció manual
      - Si matching confidence < 85%, mostrar diàleg
      - Llista de fitxers amb assignació suggerida
      - Dropdown per reassignar manualment
      - Botó "Ignorar" per fitxers no volguts
  [ ] Fitxers orfes: moure de "Resum" a "Info Seqüència"
      - Mostrar count a info, detall expandible
  [ ] KHP: mostrar TOTES les rèpliques, no només una
      - Taula amb R1, R2, etc.
      - Àrea, SNR, anomalies per cada una
      - Indicar quina s'usarà per calibrar

PAS 2 - CALIBRAR (MILLORES):
  [ ] Si ja calibrat: mostrar info sense recalibrar
      - Botó "Recalibrar" opcional
  [ ] Mostrar totes les rèpliques KHP amb mètriques
      - Àrea DOC, Àrea A254, Ratio DOC/A254
      - SNR, Simetria, Quality score
      - Checkbox per seleccionar quines usar
  [ ] Mètode selecció: Promig vs Millor qualitat
  [ ] Gràfic actualitza dinàmicament segons selecció
  [ ] Comparació històrica amb filtre doc_mode

--------------------------------------------------------------------------------
COMPLETAT AVUI (2026-01-28) - ABANS DE v3
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
COMPLETAT AVUI (2026-01-28)
--------------------------------------------------------------------------------
[x] hpsec_consolidate.py v1.6.0 - VALIDACIÓ + FILTRE CONTROLS:
    - v1.5.0: Sistema matching amb confiança (EXACT/NORMALIZED/FUZZY)
    - v1.6.0: Filtre injeccions control (MQ, NaOH, BLANK, H2O, WASH)
    - Configurable a hpsec_config.py: control_injections.patterns[]
    - Controls no es marquen com a orfes (ignore_orphan: true)
    - Testat en 17 SEQs: 0 falsos positius baixa confiança

[x] hpsec_consolidate.py v1.4.0 - CONSOLIDATION.JSON:
    Nova funcionalitat: Generació de CHECK/consolidation.json amb resum complet.

    Noves funcions:
      - _collect_sample_stats(): Recull estadístiques per mostra
      - generate_consolidation_summary(): Genera diccionari resum
      - save_consolidation_summary(): Guarda JSON a CHECK/

    Contingut consolidation.json:
      - meta: seq, date, method, mode, script_version
      - counts: total_samples, khp_samples, control_samples, regular_samples
      - alignment: shift_uib, shift_direct, source
      - timeouts: severity_counts, critical_samples
      - quality: snr_direct/uib (min/median/max), lod_direct/uib_mau
      - samples: llista detallada per mostra

    Millores:
      - Filtre valors extrems SNR (>10000) i noise (<0.01)
      - Corregit bug: result["processed"] -> result["processed_count"]

[x] HPSEC_Suite_v3.py - GUI RESUM CONSOLIDACIÓ:
    Nou frame "Resum Consolidació" al pas 1 amb:
      - Comptadors: mostres, KHP, controls
      - Alineació: shifts UIB/Direct, font
      - SNR: mediana i mínim
      - LOD: Direct i UIB (mAU)
      - Barres timeouts per severitat amb colors
      - Mostres crítiques (si CRITICAL)
      - Avisos importants

    Nova funció:
      - _show_consolidation_summary(): Mostra resum a la GUI

    Canvis:
      - _consolidation_done(): Carrega i mostra resum
      - _analyze_folder(): Carrega resum existent de consolidation.json

[x] Afegir "paths" a hpsec_config.py:
    - data_folder: "C:/Users/Lequia/Desktop/Dades2"
    - Centralitza path del repositori

[x] Actualitzar HPSEC_Suite_v2.py per usar config paths:
    - Línia 2048: ara usa self.config.get("paths", "data_folder")

[x] Afegir SNR, LOD, LOQ i baseline noise a consolidats (hpsec_consolidate.py v1.3.0):
    - Nova funció calculate_snr_info()
    - Camps afegits al full ID:
      * SNR_Direct, SNR_UIB
      * Baseline_Noise_Direct_mAU, Baseline_Noise_UIB_mAU
      * LOD_Direct_mAU, LOD_UIB_mAU (= 3 × noise)
      * LOQ_Direct_mAU, LOQ_UIB_mAU (= 10 × noise)
    - Nou paràmetre snr_info a write_consolidated_excel()
    - Les 3 crides a write_consolidated_excel() actualitzades

--------------------------------------------------------------------------------
GUI v2.1 - REDISSENY ACORDAT (2026-01-28)
--------------------------------------------------------------------------------

ESTRUCTURA FINAL (4 pàgines + modal config):

  ┌──────────────────────────────────────────────────────────┐
  │  Processar │ SEQ Status │ Repositori │ Eines │    [⚙]  │
  └──────────────────────────────────────────────────────────┘

  1. PROCESSAR
     - Pipeline automàtic (Migrar → Consolidar → Calibrar → Processar)
     - Log en temps real (streaming, sense pauses)
     - Només para si error
     - Al final: resum ràpid + botó obrir CHECK/
     - Auto-detecta darrera SEQ
     - Exportar: PENDENT DEFINIR (múltiples opcions + ZIP)

  2. SEQ STATUS (abans "Repositori")
     - Llista totes les SEQs amb estat (MF/Con/Cal/Proc)
     - Batch processing (seleccionar múltiples)
     - Reprocessar SEQs antigues
     - Icones amb llegenda

  3. REPOSITORI (abans "Històric")
     - Tab Calibracions: KHP_History.json
       * Taula amb factor, r², data, estat
       * Gràfic evolució temporal
       * Marcar outliers
       * Exportar Excel
     - Tab Mostres: Samples_History.json
       * Totes les mostres processades
       * Cercar, filtrar
       * Estadístiques per mostra
       * Exportar Excel

  4. EINES
     - Planificador T0 (optimitzar seqüències per timeouts)
     - UIB vs Direct (comparar senyals)
     - Altres eines a revisar

  5. CONFIG (modal, icona ⚙ a capçalera)
     - Paths
     - Thresholds
     - Wavelengths
     - etc.

TASQUES IMPLEMENTACIÓ:
  [x] Reestructurar navegació (4 pàgines + modal config)
  [x] Config: convertir a modal (icona ⚙ a sidebar)
  [x] Repositori: estructura tab Calibracions/Mostres
  [x] Reanomenar etapa "Processar" a "QC" (evita confusió amb pàgina)
  [x] Fix: SEQs ja processades - ara mostra diàleg confirmació (no bloqueja)
  [x] Processar: afegir taula QC interactiva (com v1)
      - Columnes: Mostra, Estat, DOC R, DOC Δ%, Sel DOC, DAD Qual, Sel DAD
      - Doble clic per obrir gràfic QAQC
      - Clic dret per canviar selecció DOC/DAD
      - Tags de color: OK (verd), WARN (taronja), FAIL (vermell), MODIFIED (blau)
  [x] Processar: panell resum amb stats (fitxers, mostres, KHP, factor)
  [x] Processar: log detall col·lapsable
  [x] hpsec_pipeline.py: reanomenar step "processar" a "qc"
  [ ] Processar: obrir CHECK/ al final
  [ ] SEQ Status: batch processing funcional
  [ ] Repositori: poblar tab Calibracions des de KHP_History.json
  [ ] Repositori: poblar tab Mostres des de Samples_History.json
  [ ] Eines: revisar funcionalitats necessàries

--------------------------------------------------------------------------------
PENDENT
--------------------------------------------------------------------------------
[ ] RECONSOLIDAR TOTES LES SEQÜÈNCIES:
    - Afegeix: timeout info, SNR, LOD, LOQ, baseline noise
    - Executar quan sigui convenient (procés llarg)
    - Considerar fer-ho en batch overnight

--------------------------------------------------------------------------------
SESSIO ANTERIOR - 2026-01-26
--------------------------------------------------------------------------------

TASCA ANTERIOR: HPSEC Suite v2 - GUI Professional

--------------------------------------------------------------------------------
GUI SUITE v2 - IMPLEMENTAT
--------------------------------------------------------------------------------
[x] Nova estructura GUI:
    - Planificar SEQ: Optimitzar T0 per evitar timeouts en zones crítiques
    - Processar SEQ: Processar seqüència (auto-detecta darrera o selecció manual)
    - Estat Repositori: Visió general de totes les SEQs i el seu estat
    - Eines: Comparacions, diagnòstic, planificador timeout
    - Configuració: Paràmetres centralitzats

[x] Detecció automàtica d'estat per SEQ:
    - MasterFile: existeix o cal migrar
    - Consolidat: carpeta Resultats_Consolidats
    - Calibrat: CHECK/calibration.json
    - Processat: CHECK/processing_summary.json
    - Versió: compara versió processament vs versió actual pipeline

[x] Tracking de versió del pipeline:
    - PIPELINE_VERSION a hpsec_pipeline.py
    - Es guarda a processing_summary.json
    - GUI detecta si cal reprocessar per canvi de versió

[x] Mòduls nous creats:
    - hpsec_config.py: Gestió centralitzada configuració (JSON)
    - hpsec_gui.py: Components GUI moderns (ModernCard, ProgressPanel, etc.)
    - hpsec_planner.py: Planificador seqüències per optimitzar timeout TOC
    - hpsec_pipeline.py: Pipeline integrat (migrar→consolidar→calibrar→processar→exportar)
    - HPSEC_Suite_v2.py: Nova GUI professional

--------------------------------------------------------------------------------
GUI SUITE v2 - ARREGLAT (2026-01-26)
--------------------------------------------------------------------------------
[x] Bug crític _create_repositori_page:
    - Codi botons i "return page" estaven dins _on_repo_selection_change
    - Arreglat: la funció ara retorna correctament el frame page
    - Navegació entre pàgines ara funciona correctament

[x] Mida finestra reduïda:
    - Mida inicial: 700x450 (era 800x500)
    - Mida mínima: 600x400 (era 700x450)

--------------------------------------------------------------------------------
GUI SUITE v2 - FINESTRES ACTUALITZADES (2026-01-27)
--------------------------------------------------------------------------------
[x] FINESTRA REDIMENSIONADA (2026-01-27):
    - Mida inicial: 70% pantalla (màx 900x650)
    - Mida mínima: 600x450
    - Sidebar: 70px amb icones i text
    - Fonts: 9-10pt (llegibles)

[x] PLANIFICAR SEQ - TAULA DETALLADA:
    - Mostra TOTES les mostres amb timeout previst
    - Columnes: Mostra | Timeout | Zona | Severitat | Descripció
    - Estadístiques per severitat (CRITICAL, WARNING, INFO, OK)
    - Resum per zones amb comptadors

[x] PROCESSAR SEQ - PIPELINE PAS A PAS (2026-01-27):
    - REDISSENYAT: Ara és pas a pas amb confirmació de l'usuari
    - L'usuari ha de fer clic "Següent" després de cada etapa
    - Errors EXPLÍCITS amb traceback complet
    - Cada etapa mostra detalls específics (fitxers, factor, mostres...)
    - Botons: Iniciar | Següent | Aturar | Obrir Resultats
    - Si error: opció de reintentar o saltar etapa
    - Funcions noves a hpsec_pipeline.py:
        * run_migration_step()
        * run_consolidation_step()
        * run_calibration_step()
        * run_processing_step()
        * run_export_step()

[x] CONSOLIDAR - MISSATGES MILLORATS (2026-01-27):
    - Mostra fitxers UIB i DAD trobats explícitament
    - Si ja consolidat: "Ja consolidat (X fitxers existents)"
    - Si no troba fitxers: explica on ha buscat (CSV/, Export3D/)
    - Mostra MasterFile si existeix
    - Detalla mostres consolidades vs fitxers font

    Pàgines pendents de revisar visualment:
    [ ] Repositori
    [ ] Eines
    [ ] Config

--------------------------------------------------------------------------------
GUI SUITE v2 - PENDENT
--------------------------------------------------------------------------------
[ ] FINESTRA - MILLORES ADDICIONALS:
    - Guardar última mida/posició a config
    - Si encara és massa gran per algunes pantalles, considerar scroll

[ ] REPOSITORI A CONFIG:
    - Moure path "C:/Users/Lequia/Desktop/Dades2" a hpsec_config.py
    - Permetre canviar des de GUI (pàgina Config)
    - Validar que existeix abans d'escanejar

[ ] SHAREPOINT/TEAMS:
    - Opció 1 (Recomanada): OneDrive sync → carpeta local
    - Opció 2: Mappejar unitat de xarxa (requereix VPN fora UdG)
    - Opció 3: Microsoft Graph API (complex, auth OAuth2, lent)
    - Opció 4: WebDAV mount (pot ser lent amb Excels grans)
    - Opció 5: rclone mount (requereix instal·lar rclone)
    - DECISIÓ PENDENT: quin mètode implementar?

[ ] REANOMENAR MASTERFILES SEGONS ESTAT:
    - Format proposat (pendent decisió):
      * XXX_MasterFile.xlsx     → migrat (raw)
      * XXX_MasterFile_C.xlsx   → consolidat
      * XXX_MasterFile_Cal.xlsx → calibrat
      * XXX_MasterFile_P.xlsx   → processat
    - Permet veure estat sense obrir fitxer
    - Requereix actualitzar totes les funcions que busquen MasterFile

[ ] BATCH PROCESSING:
    - Implementar "Processar Totes Pendents" a Estat Repositori
    - Progress bar global + per SEQ
    - Log de resultats

[ ] EINES PENDENTS D'INTEGRAR:
    - Comparació rèpliques (compare_replicas_direct.py?)
    - Control charts (generate_control_charts.py)
    - [x] Planificador timeout (hpsec_planner.py) - INTEGRAT a pàgina "Planificar SEQ"

[ ] PLANIFICADOR SEQ - MILLORES:
    - Adaptar per seqüències BYPASS (diferents zones crítiques, durades)
    - Afegir visualització gràfica dels timeouts predits
    - Opció d'exportar pla a PDF/Excel

--------------------------------------------------------------------------------
TASCA ANTERIOR: Detecció automàtica de timeouts TOC

COMPLETAT AVUI (2026-01-26):
  [x] Anàlisi cicle recàrrega xeringues TOC:
      - Cicle: 77.2 min (1140 mesures × ~4.06s)
      - Timeout: 74 segons
      - Durada mostra HPLC: 78.65 min
      - Deriva per mostra: 1.45 min (timeout "retrocedeix")

  [x] Model predictiu de timeouts:
      - Fórmula: Pos_timeout(N) = T0 - (N-1) × 1.45 (mod 77.2)
      - Verificat amb 6 seqüències: r = 0.9982, error mitjà 1.2%
      - Documentat a: PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md

  [x] Detecció automàtica timeouts a hpsec_consolidate.py:
      - Nova configuració TIMEOUT_CONFIG (zones i severitats)
      - Nova funció detect_doc_timeouts() - detecta per cadència dades
      - Nova funció format_timeout_status()
      - Modificades extract_doc_from_masterfile/master() - retornen timeout_info
      - Modificada write_consolidated_excel() - escriu timeout info a ID
      - Warnings durant consolidació per timeouts en zona crítica

  [x] Nivells de severitat implementats:
      | Zona      | Rang (min) | Severitat |
      |-----------|------------|-----------|
      | RUN_START | < 1        | INFO      |
      | BioP      | 0-18       | WARNING   |
      | HS        | 18-23      | CRITICAL  |
      | BB        | 23-30      | WARNING   |
      | SB        | 30-40      | WARNING   |
      | LMW       | 40-70      | INFO      |
      | POST_RUN  | > 70       | OK        |

  [x] Output al full ID dels consolidats:
      - TOC_Timeout_Detected: YES/NO
      - TOC_Timeout_Count: nombre de timeouts
      - TOC_Timeout_Severity: OK/INFO/WARNING/CRITICAL
      - TOC_Timeout_N: detalls (posició, duració, zona)
      - TOC_Zones_Affected: zones amb timeout
      - TOC_Dt_Median_sec / TOC_Dt_Max_sec

  [x] REFACTORING HPSEC_Suite.py i hpsec_replica.py (2026-01-26):

      hpsec_replica.py v1.2:
        - Afegida avaluació DAD (evaluate_dad, evaluate_dad_multi)
        - Afegida comparació DOC-DAD (compare_doc_dad)
        - Afegida compare_replicas_full() per comparació completa
        - SNR i Pearson actius per selecció COLUMN (abans només BP)
        - Nous thresholds: DAD_DRIFT_WARNING/CRITICAL, DAD_DOC_CORR

      HPSEC_Suite.py optimitzat (7244 → 6530 línies, -714 línies):
        - Eliminat avaluar_qualitat_dad() (ara usa evaluate_dad)
        - Eliminat calcular_roughness() (duplicat d'avaluar_qualitat_doc)
        - Eliminat analyze_sample_areas() (importa de hpsec_consolidate)
        - Eliminat write_consolidated_excel() (importa de hpsec_consolidate)
        - Eliminat get_baseline_correction() (importa de hpsec_consolidate)
        - Eliminat apply_smoothing() (importa de hpsec_consolidate)
        - Refactoritzat avaluar_qualitat_dad_replica() per usar evaluate_dad
        - Refactoritzat seleccionar_millor_dad() amb lògica millorada

PENDENT:
  [ ] Reconsolidar totes les seqüències per afegir info timeout
  [ ] Generar report resum de timeouts per seqüència
  [ ] Considerar canvi durada mostra a 77.2 min (elimina deriva)

  [x] AFEGIR SNR i LOD A CONSOLIDATS (IMPLEMENTAT 2026-01-28):
      Anàlisi realitzada (156 mostres DUAL):
        - Direct té millor LOD que UIB (1.24 vs 1.85 mAU a 700 ppb)
        - 700 ppb té millor LOD que 1000 ppb (1.85 vs 3.47 mAU)
        - El canvi a 1000 ppb (SEQ≥275) va augmentar soroll 2.4x

      Per mostra (afegir al full ID del consolidat):
        - SNR_UIB, SNR_Direct
        - Baseline_Noise_UIB, Baseline_Noise_Direct (mAU)

      Per seqüència (afegir a MasterFile o JSON):
        - LOD_UIB, LOD_Direct (= 3 × median baseline noise)
        - LOQ_UIB, LOQ_Direct (= 10 × median baseline noise)
        - Sensitivity_ppb (700 o 1000)

      Documentació:
        - PROVES/uib_sensitivity/comparacio_700_vs_1000.png
        - PROVES/uib_sensitivity/lod_snr_comparison.png
        - PROVES/uib_sensitivity/uib_sensitivity_metrics.csv

  [ ] DOCUMENTAR CANVIS SIMULTANIS SEQ 275:
      A partir de SEQ 275 es van fer DOS canvis alhora:
        1. Volum injecció Column: 100 µL → 400 µL (4x)
        2. Sensibilitat UIB: 700 ppb → 1000 ppb

      EFECTE COMBINAT OBSERVAT (no es poden separar):
        | Mètrica      | UIB    | Direct | Teòric si només volum |
        |--------------|--------|--------|----------------------|
        | Peak         | 2.24x  | 3.20x  | 4x                   |
        | Area         | 1.54x  | 2.27x  | 4x                   |
        | Baseline     | 1.89x  | 2.79x  | ~1x                  |
        | SNR          | 1.08x  | 1.02x  | 4x                   |

      Senyal normalitzat per µL (UIB): 0.56x
        → Menys senyal per µL injectat amb nova configuració

      CONCLUSIONS:
        - El SNR NO millora malgrat 4x més volum
        - El baseline també augmenta (~2-3x), cancel·lant benefici
        - No es pot saber si és pel volum, sensibilitat, o ambdós
        - Direct escala millor que UIB (3.2x vs 2.2x)

      RECOMANACIÓ FUTURA:
        - Si es vol comparar efecte volum vs sensibilitat, caldria
          fer experiments separats (un canvi a la vegada)

      Documentació:
        - PROVES/uib_sensitivity/injection_volume_comparison.png
        - PROVES/uib_sensitivity/injection_volume_metrics.csv

  [x] REFACTORITZAR DETECCIÓ ANOMALIES (COMPLETAT 2026-01-26):
      Objectiu: Unificar tota la lògica de detecció en hpsec_core.py

      FASE 1-4 COMPLETADES:
        hpsec_core.py (SINGLE SOURCE OF TRUTH):
          ├── detect_timeout()         ← MOGUT des de consolidate
          ├── detect_batman()          ← Ja existia (mantingut)
          ├── detect_peak_anomaly()    ← Ja existia (híbrid batman+smoothness)
          ├── detect_main_peak()       ← MOGUT des de calibrate
          ├── detect_all_peaks()       ← MOGUT des de calibrate
          ├── integrate_chromatogram() ← NOU: mode='full'|'main_peak'
          ├── format_timeout_status()  ← MOGUT des de consolidate
          └── TIMEOUT_CONFIG           ← MOGUT des de consolidate

        hpsec_calibrate.py:
          └── validate_khp_quality()   ← NOU: validació específica KHP
              - Multi-pic (>2 pics significatius)
              - Timeout en zona del pic
              - Batman/irregular
              - Simetria acceptable (0.5-2.0)
              - SNR > 50

        hpsec_consolidate.py:
          └── import detect_timeout, format_timeout_status, TIMEOUT_CONFIG from hpsec_core
              (-185 línies eliminades)

      FASE 5 COMPLETADA:
        [x] DOCtor_C.py v1.1 - AMORPHOUS ELIMINAT (2026-01-26)
            Detecció amorphous era precària i generava molts FP.
            Timeout via dt intervals és més robust.

            Eliminat (~685 línies):
              - detect_amorphous() (~370 línies)
              - detect_amorphous_on_peak() (~70 línies)
              - validate_amorphous_with_replicates() (~190 línies)
              - calc_smoothness() (~55 línies)
              - Tots els camps is_amorphous, amorphous_info, etc.
              - Visualització i estadístiques amorphous

        [x] DOCtor_C.py v1.2 - SIMPLIFICACIÓ DETECCIÓ (2026-01-26)
            Eliminades deteccions que no funcionen bé.

            Eliminat (~325 línies addicionals):
              - detect_timeout() local mesetes (~145 línies)
              - detect_ears() (~95 línies)
              - calc_monotonicity() (~50 línies)
              - detect_peak_problem() (~35 línies)
              - Camps: has_stop, stop_*, mono_*, ears

            Detecció final basada en:
              - Batman (via detect_peak_anomaly)
              - IRR (smoothness < 18%)
              - Timeout (via hpsec_core.detect_timeout - dt intervals)

        [x] DOCtor_BP.py v1.7 - USA HPSEC_REPLICA (2026-01-26)

      DETALL COMPLET: veure PLAN_REFACTOR_DETECCIO.md

  [ ] OPTIMITZAR CROMATOGRAMES SEGONS TIMEOUT TOC:
      Basat en l'anàlisi de 331 mostres DUAL (Direct vs UIB):

      DURACIO ZONA AFECTADA PEL TIMEOUT:
        - PRE-timeout:  ~0.5 min (xeringa buidant-se, mesures inestables)
        - Timeout gap:  ~1.2 min (74s, sense dades)
        - POST-timeout: ~1.0 min (estabilització després recàrrega)
        - TOTAL:        ~2.5-3 min afectats

      ACCIONS A IMPLEMENTAR:
        a) Revisar hpsec_consolidate.py per marcar zona afectada completa
           - Afegir camps: TOC_Affected_Zone_Start, TOC_Affected_Zone_End
           - Calcular: t_start - 0.5 min fins t_end + 1.0 min

        b) Afegir warning si zona afectada solapa amb pics crítics
           - Usar integració d'àrea a zona afectada vs àrea total
           - Flag si àrea_afectada / àrea_total > llindar (ex: 5%)

        c) Generar mètriques de qualitat per zona afectada:
           - Pearson local a la zona PRE/POST
           - RMSE a la zona afectada

      RECOMANACIÓ OPERATIVA (per tècnics):
        - Canviar durada mètode HPLC de 78.65 min a 77.2 min
        - Esperar 3-5 min després del flush abans d'iniciar seqüència
        - Resultat: 100% timeouts en zona post-run (sense impacte)

      DOCUMENTACIÓ:
        - PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md
        - PROVES/timeout_impact/informe_timeout_*.png

--------------------------------------------------------------------------------
SESSIO ANTERIOR - 2025-01-25 09:15
--------------------------------------------------------------------------------

TASCA ANTERIOR: MasterFile - Template i estratègia de càlcul

COMPLETAT:
  [x] 23:25 - Unificació estructura MasterFiles (38 fitxers)
      - Estructura canònica: 0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP, 4-TOC_CALC
      - Script: hpsec_unify_masterfiles.py

  [x] 23:45 - Actualització hpsec_consolidate.py per nou format MasterFile
      - Backup: hpsec_consolidate_backup_20250124.py
      - Compatible amb format antic (4-SEQ_DATA) i nou (4-TOC_CALC)
      - 4-TOC_CALC es calcula al vol quan es consolida (no fórmules Excel)

  [x] 09:15 - Creació Template a Dades2/Template/
      - MasterFile_Template.xlsx: Plantilla buida amb estructura
      - 256_MasterFile_EXEMPLE.xlsx: Exemple complet de referència

ESTRATEGIA TOC_CALC:
  - NO regenerar tots els MasterFiles existents
  - 4-TOC_CALC es calcula sota demanda des de hpsec_consolidate.py
  - Més eficient: càlcul Python vs fórmules Excel
  - Noves SEQs: usar Template + script d'importació

PENDENT:
  [~] Verificació alineació DOC-DAD amb KHP (EN CURS)
      - Usar 3-DAD_KHP del MasterFile
      - Calcular shift temporal DOC vs A254
      - Verificar impacte en mapping TOC→mostra

  [ ] Propagar lògica nomenclatura Sample_Bx_Ry a tots els scripts
      - Origen: _create_sample_rep() a hpsec_migrate_master.py
      - Format: Sample_B1_R1, Sample_B1_R2, Sample_B2_R1... (quan hi ha duplicats)
      - Format simple: Sample_R1, Sample_R2 (quan no hi ha duplicats)
      - Afecta: hpsec_consolidate.py, DOCtor_BP.py, DOCtor_C.py, reports

  [ ] Convenció noms MasterFile segons estat processament
      - XXX_MasterFile.xlsx     → migrat (raw, fulls 0-4)
      - XXX_MasterFile_C.xlsx   → consolidat (+ 5-SUMMARY)
      - XXX_MasterFile_Cal.xlsx → calibrat (+ 6-CALIBRATION)
      - XXX_MasterFile_P.xlsx   → processat DOCtor (+ 7-RESULTS?)
      - Cada pas reanomena el fitxer i afegeix full corresponent
      - Permet veure estat sense obrir el fitxer

  [x] Reestructurar fitxers consolidats (IMPLEMENTAT 2025-01-26):
      Nova estructura Excel amb 5 fulls:
        - ID: Identificació, fitxers, estat, processament (simplificat, sense àrees)
        - TMAX: Temps de retenció per DOC i cada wavelength DAD
        - AREAS: Àrees per fraccions de temps (BioP, HS, BB, SB, LMW, total)
        - DOC: Cromatograma DOC (net, raw, baseline)
        - DAD: Cromatograma DAD (totes les wavelengths)

      Fraccions de temps (time_fractions):
        - BioP: 0-18 min (Biopolímers)
        - HS: 18-23 min (Àcids húmics)
        - BB: 23-30 min (Building Blocks)
        - SB: 30-40 min (Small Building blocks)
        - LMW: 40-70 min (Low Molecular Weight)

      Noms columnes en anglès: Field/Value, Signal, Fraction, Range

  [ ] Revisar report consolidats (HPSEC_Suite.py)
      - Adaptar generació PDF/reports a nova estructura (TMAX, AREAS)
      - Verificar que llegeix correctament els nous fulls

  [x] Reconsolidar totes les seqüències (COMPLETAT 2025-01-26)
      - 32/33 seqüències OK (655 fitxers consolidats)
      - ERROR: 261D_SEQ_BP (no té MasterFile propi, fitxers de 261C)
      - Nova estructura amb fulls TMAX i AREAS aplicada
      NOTA: Caldrà reprocessar quan s'estandarditzin temps i versions

  [x] BUG CORREGIT + RECONSOLIDAT: Alineació DUAL (2026-01-26)
      PROBLEMA ORIGINAL:
        - calculate_column_alignment_shifts() buscava "DOC (mAU)"
          però fitxers DUAL tenen "DOC_Direct (mAU)"

      FIX IMPLEMENTAT (v2):
        1. Afegit llegir_dad_1a() per format DAD1A (UTF-16, tab, sense capçalera)
        2. Afegit llegir_dad_amb_fallback() amb prioritat Export3D -> DAD1A
        3. Modificat alineació per suportar format MasterFile NEW i OLD
        4. L'alineació ara usa DAD Export3D o fallback a DAD1A per A254

      RECONSOLIDACIÓ FINAL (17 SEQs):
        - Shifts calculats correctament amb Export3D com a font DAD
        - 274_SEQ: shift_direct = -44.3s (abans era 0!)
        - 275_SEQ: shift_direct = -49.3s (abans era 0!)

      MILLORA QUALITAT PERFILS:
        - 700 ppb: Pearson 0.9501 -> 0.9838 (+0.034)
        - 1000 ppb: Pearson 0.9531 -> 0.9916 (+0.039)
        - Mostres "dolentes" (r<0.95): 53 -> 14 (-74%)
        - Correlació N_Points eliminada (r=-0.28 -> r=0.04)

      - NOTA: 271_SEQ_BP té KHP anomal (4000+ mAU), usar SEQ propera per alineació

  [x] Estandarditzar límits temporals cromatogrames (IMPLEMENTAT 2026-01-26)
      - Truncar tots els cromatogrames a 70 min màxim
      - Configurable via DEFAULT_CONSOLIDATE_CONFIG["max_time_min"]
      - S'aplica a DOC i DAD a write_consolidated_excel()

  [x] Afegir versionat als fitxers consolidats (IMPLEMENTAT 2026-01-26)
      - Script_Version: hpsec_consolidate v1.1.0
      - Consolidation_Date: timestamp de quan es va generar
      - Permet saber amb quina versió es van processar les dades

  [x] Sistema de versions pels scripts (IMPLEMENTAT 2026-01-26)
      - __version__ = "1.1.0" a hpsec_consolidate.py
      - __version_date__ = "2026-01-26"
      - Format: MAJOR.MINOR.PATCH

  [ ] Documentar deriva DAD (QC opcional)
      - Càlcul: mitjana(t>60) - mitjana(t<10) per cada wavelength
      - Valors típics: 0.03-0.53 mAU (petits)
      - A290 pot tenir deriva negativa
      - Flag QC si deriva > llindar (a definir)
      - Nota: deriva DOC a temps llargs pot ser senyal real (compostos)

  [ ] PENDENT: Analitzar estructura final MasterFile abans d'implementar
      - Definir fulls nous post-consolidació:
        * 5-TMAX: temps retenció per mostra (format llarg)
        * 6-AREAS: àrees per fracció (format llarg)
        * 7-PROCESSING: baseline, deriva, versió, QC
      - Decidir què es guarda vs què es recalcula
      - Revisar mètodes baseline: mode_robust (DOC) vs percentile_5 (DAD)
      - Documentar subsampling DAD (factor 5)

  [ ] Crear script importació per noves SEQs (usa Template)
  [ ] Commit canvis a git

################################################################################

[x] CONSOLIDACIO: Verificar fitxers (IMPLEMENTAT)
    - Al consolidar, comptar quants fitxers hi ha al directori origen
    - Comptar quants s'han utilitzat/processat
    - Alertar si hi ha discrepancia (ex: R12 en lloc de R2, fitxers orfes, etc.)
    - Cas detectat: FR2395_273_BP tenia R1 i R12 (error nomenclatura)

    [x] Detecció discrepàncies a hpsec_consolidate.py:
        - Retorna files_found, files_used, files_orphan al result["file_check"]
        - Detecta anomalies nomenclatura (R12 → R2)
        - Genera proposed_renames amb raó i confiança
        - Guarda a HPSEC_QAQC/File_Check_[SEQ].json si hi ha problemes
        - Funció apply_renames() preparada per aplicar canvis

    [ ] GUI per gestionar renames (quan s'integri a Suite):
        - Taula amb Original | Proposta | Acció
        - Opcions: Rename / Ignorar / Editar manualment
        - Botó aplicar canvis

--------------------------------------------------------------------------------
ORGANITZACIO CODI
--------------------------------------------------------------------------------
[x] hpsec_core.py - Funcions compartides BP:
    - bigaussian, fit_bigaussian, check_asymmetry
    - detect_batman (artefactes al cim del pic)
    - detect_timeout (dt intervals) - timeout TOC
    - detect_peak_anomaly (batman + smoothness híbrid)
    - repair_with_parabola, find_tangents_and_anchors
    - calc_snr, calc_peak_area, calc_pearson, calibrate_factor
    - Constants globals (THRESH_R2_*, REPAIR_*, ASYM_*, TIMEOUT_CONFIG)

[x] hpsec_replica.py v1.2 - Selecció de rèpliques amb DAD:
    Funcions DOC:
      - evaluate_replica(t, y, method) - avaluació unificada
      - select_best_replica(eval1, eval2, method, dad_eval) - selecció COLUMN/BP
      - compare_replicas(t1, y1, t2, y2) - Pearson i àrea

    Funcions DAD (NOU v1.2):
      - evaluate_dad(t, y) - deriva, soroll, SNR per wavelength
      - evaluate_dad_multi(t, dad_data) - múltiples wavelengths
      - compare_doc_dad(t_doc, y_doc, t_dad, y_dad) - correlació DOC-DAD
      - compare_replicas_full(...) - comparació completa DOC+DAD

    Criteris COLUMN: Batman > Timeout > IRR > DAD_POOR > SNR > DAD_drift > Alçada
    Criteris BP: Batman > R² status > R² valor > SNR (+DAD warnings)

    Llindars:
      - SNR_RATIO 1.5x, PEARSON_WARNING 0.990, AREA_DIFF 15/30%
      - DAD_DRIFT 1.0/3.0 mAU, DAD_NOISE 0.5 mAU, DAD_DOC_CORR 0.90/0.95
    - Usat per: DOCtor_C v1.3, DOCtor_BP v1.7, HPSEC_Suite

[x] hpsec_utils.py - Utilitats generals:
    - baseline_stats, detect_main_peak
    - detect_batman (pics dobles coeluits - columna)
    - seleccionar_carpeta, obtenir_seq, normalize_key
    - is_khp, extract_khp_conc

[x] hpsec_reports.py - Mòdul generació PDFs professional:
    - generate_consolidation_report(): Resum + taula punts Direct/UIB/DAD
    - generate_chromatograms_report(): Rèpliques R1|R2 juntes, ordenat
    - Ordenació: Mostres → KHP → Controls (MQ/NaOH)
    - Format científic: logo, capçalera minimalista, peu de pàgina
    - 4 parells per pàgina, eixos etiquetats
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[x] hpsec_consolidate.py - Mòdul consolidació extret de Suite:
    - Funcions lectura: llegir_doc_uib, llegir_dad_export3d, trobar_excel_mestre
    - Funcions processament: process_dad, detect_main_peak, analyze_sample_areas
    - Funció principal: consolidate_sequence(seq_path, config, progress_callback)
    - Funció escriptura: write_consolidated_excel()
    [x] DUAL PROTOCOL: Extreu DOC de UIB (CSV) i Direct (Excel mestre)
        - Output: time, DOC (Direct), DOC_UIB
        - Escala temps: Direct (~4 sec, real) vs UIB (~0.32 sec, fictícia)
    [x] ALINEACIÓ:
        - BP: Alinea pel màxim de cada mostra individualment
        - COLUMN: Alinea amb KHP + A254 com a referència
    [x] LOG QAQC (HPSEC_QAQC/Alignment_History.json):
        - Guarda shifts d'alineació per cada SEQ COLUMN
        - Fallback: si no hi ha KHP, usa alignment de SEQ propera en el temps
        - Camps: timestamp, seq_name, seq_date, method, shifts, khp_file, details

[x] Integrar hpsec_consolidate.py a HPSEC_Suite.py
    - Substituir codi inline per import del mòdul
    - Eliminar funcions duplicades de la Suite

[!] IMPORTANT - CALIBRACIÓ afectada per origen DOC:
    - Si hi ha DUAL (Direct + UIB): usar Direct com a principal
    - Si només hi ha UIB (sense Direct): usar UIB com a fallback
    - AFECTA CALIBRACIÓ: els factors són diferents!
      * Direct: 0.82
      * UIB < SEQ 275: 0.84
      * UIB >= SEQ 275: 0.87
    - El camp DOC_MODE a ID indica l'origen usat (DUAL, UIB, DIRECT)
    - La Suite ha de llegir DOC_MODE per aplicar el factor correcte!

[x] hpsec_calibrate.py - Mòdul calibració standalone:
    - Anàlisi KHP: analizar_khp_consolidado, analizar_khp_lote
    - Cerca KHP: buscar_khp_consolidados (LOCAL → SIBLINGS → MANUAL)
    - Gestió historial: CALDATA local + KHP_History global
    - Registre: register_calibration, mark_calibration_as_outlier
    - Funció principal: calibrate_sequence(seq_path, config, callbacks)
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[ ] Considerar fusionar hpsec_utils i hpsec_core en un sol modul
    - Renombrar detect_batman per clarificar:
      * detect_peak_notch (artefactes BP)
      * detect_double_peak (pics coeluits columna)

--------------------------------------------------------------------------------
FILTRES IMPLEMENTATS (DOCtor_BP v1.7)
--------------------------------------------------------------------------------
[x] Bi-Gaussiana (sigma_left != sigma_right)
[x] Deteccio Batman (valls al cim del pic)
[x] Reparacio parabola amb factor 0.85
[x] Filtre R2 >= 0.98 per reparar (exclou pics escombraries)
[x] Filtre asimetria 0.33-3.0 (detecta errors detector DOC)
[x] Mostra R2 i dH abans/despres de reparacio

--------------------------------------------------------------------------------
LLINDARS ACTUALS
--------------------------------------------------------------------------------
THRESH_R2_VALID = 0.987      # R2 >= 0.987 -> VALID
THRESH_R2_CHECK = 0.980      # 0.980 <= R2 < 0.987 -> CHECK
REPAIR_MIN_R2 = 0.980        # No reparar si R2 < 0.98
ASYM_MIN = 0.33              # Asimetria minima acceptable
ASYM_MAX = 3.0               # Asimetria maxima acceptable
REPAIR_FACTOR = 0.85         # Factor correccio tangent

--------------------------------------------------------------------------------
ANOMALIES A REVISAR
--------------------------------------------------------------------------------
[!] 271_SEQ_BP - KHP ANOMAL (NO USAR PER CALIBRACIO/ALINEACIO)
    - KHP2_271_BP_R1: 4060 mAU
    - KHP2_271_BP_R2: 4140 mAU
    - Valors normals KHP2: 180-1000 mAU (mitjana ~450 mAU)
    - Valores 271 són 4-6x superiors al normal
    - EXCLOURE d'alineació i calibració

[ ] KHP2_284_BP te altura anomalament alta (242 mAU) vs KHP2_277 (149) i KHP2_281 (183)
    - Mateixa concentracio, mateixa sensibilitat (UIB>=275)
    - Possible canvi de fungible DOC entre seqüències?
    - Revisar historial de manteniment del detector

[ ] Implementar detecció anomalies KHP abans d'usar per alineació/calibració
    - Calcular mitjana i desviació estàndard de tots els KHPs
    - Marcar com a outlier si valor > mitjana + 3*std
    - Afecta: calculate_column_alignment_shifts() a hpsec_consolidate.py
    - Afecta: calibrate_sequence() a hpsec_calibrate.py
    - Llista negra actual: 271_SEQ_BP

--------------------------------------------------------------------------------
NOTES
--------------------------------------------------------------------------------
- Directes son diferents de UIB
- UIB te canvi sensibilitat a seq 275 (700 ppb -> 1000 ppb)
- Factor calibracio: Directe=0.82, UIB<275=0.84, UIB>=275=0.87

--------------------------------------------------------------------------------
PENDENT - REVISIO FULL ID CONSOLIDATS
--------------------------------------------------------------------------------
[ ] Reestructurar fulla ID dels fitxers consolidats:
    - Esborrar full ID si existeix i crear des de zero
    - Camps d'identificació (del mestre):
      * Date, SEQ, Mostra, Replica (extreure del fitxer mestre)
      * INJ_Volum (nou - s'afegirà als mestres)
      * UIB_range (nou - s'afegirà als mestres)
      * Fitxer_Mestre: nom del fitxer Excel origen
    - Method: auto-detect (COLUMN/BP) però permetre canvi manual
    - Mode: auto-detect (UIB/DIRECT/DUAL)
    - Camps de consolidació (a definir)
    - UIB_Offset: raw/final + warning a columna C si cal
    - Camps de resultats: a definir posteriorment

    PROPOSTA: L'usuari crearà Excel amb estructura proposada

[ ] JSON per SEQ amb detalls tècnics de transformació:
    - Offsets, shifts, baselines, etc.
    - Info que no cal a cada consolidat individual

--------------------------------------------------------------------------------
PENDENT - GESTIO OFFSET UIB (Anàlisi completada 2025-01-24)
--------------------------------------------------------------------------------
[ ] Implementar monitoratge offset UIB:
    - Offset normal: -3.637 min (±0.1s entre mostres)
    - Llindars:
      * OK: offset entre [-3.65, -3.62] min
      * WARNING: diff 0.015-0.1 min
      * ERROR: diff > 0.1 min
    - Anomalies detectades: 279B_SEQ (+35min), 283_SEQ FR2606_R1 (0.005)

[ ] Implementar alineació DAD-DOC:
    - Corregir SEMPRE (eliminar tolerància 2s actual)
    - Shift esperat: ~-0.5s (DAD-DOC)
    - Llindars:
      * OK: |shift + 0.5| < 1.5s
      * WARNING: 1.5s < |shift| < 5s
      * ERROR: |shift| > 5s
    - Cas 272_SEQ: KHP incorrecte (shift 40s) → usar fallback

[ ] Protocol fallback quan KHP invàlid:
    - Usar SEQ anterior (BP o COLUMN, és igual per offset)
    - WARNING si SEQ anterior > 30 dies
    - ERROR si SEQ anterior > 90 dies

[ ] Documentació:
    - JSON per SEQ: detalls transformació
    - ID consolidat: UIB_Offset: raw/final + warning col C

--------------------------------------------------------------------------------
MASTERFILE - ESTRUCTURA CANONICA (Unificat 2025-01-24)
--------------------------------------------------------------------------------
[x] Estructura canònica unificada per tots els MasterFiles:
    0-INFO:       Metadata + sincronització
                  - SEQ-ID, Date, Method (COLUMN/BP)
                  - Inj_Volume (100 BP, 400 COLUMN excepte 256-274)
                  - UIB_range: None (sense UIB), 700 ppb (269-274), 1000 ppb (>=275)
                  - Hora HPLC, Hora TOC, Desfase, Flush time, Net delay
    1-HPLC-SEQ:   Injeccions + Inj_Index + Sample_Rep
    2-TOC:        Dades DOC contínues (raw, intocable)
    3-DAD_KHP:    Dades DAD només de KHP (opcional, si n'hi ha)
    4-TOC_CALC:   Càlculs (TOC_Row, Sample, Temps_Relatiu, Inj_Index) - SEMPRE AL FINAL

[x] Mòdul migració: hpsec_migrate_master.py
    - Detecta Method per nom carpeta (_BP) o temps execució
    - Extreu KHP amb sufixos _R1, _R2 per múltiples rèpliques
    - Crea backup automàtic abans de migrar
    - Suporta migració individual o en lot (--all)

[x] Mòdul unificació: hpsec_unify_masterfiles.py (NOU 2025-01-24)
    - Unifica tots els MasterFiles a l'estructura canònica
    - Renombra fulls: TOC_CALC -> 4-TOC_CALC, DAD_KHP -> 3-DAD_KHP
    - Reordena: TOC_CALC sempre al final
    - Elimina fulls redundants (3-SEQ_DATA)
    - Afegeix Sample_Rep a 1-HPLC-SEQ si falta
    - Crea backup automàtic abans de modificar

    Ús:
      python hpsec_unify_masterfiles.py --scan        # Dry run
      python hpsec_unify_masterfiles.py --apply       # Aplicar canvis

    Estat unificació (2025-01-24):
      - 38 fitxers MasterFile unificats
      - 29 amb estructura completa (amb 3-DAD_KHP)
      - 9 sense DAD_KHP (no tenien KHP)
      - Backups creats a cada carpeta SEQ

[ ] Actualitzar hpsec_consolidate.py per treballar amb nou MasterFile

================================================================================
REGISTRE DE SCRIPTS
================================================================================

Format: [DATA HORA] script.py - Descripció breu

[2026-01-26 xx:xx] hpsec_replica.py v1.2 - AVALUACIÓ DAD
    Single Source of Truth per avaluar i seleccionar rèpliques.

    Funcions DOC:
      - evaluate_replica(t, y, method) - avalua qualitat (batman, timeout, irr, r2, snr)
      - select_best_replica(eval1, eval2, method, dad_eval) - selecciona millor
      - compare_replicas(t1, y1, t2, y2) - Pearson i diferència àrea

    Funcions DAD (NOU):
      - evaluate_dad(t, y) - deriva, soroll, SNR per wavelength
      - evaluate_dad_multi(t, dad_data) - avalua A254, A280, etc.
      - compare_doc_dad(t_doc, y_doc, t_dad, y_dad) - correlació DOC-DAD
      - compare_replicas_full(...) - comparació completa DOC+DAD

    COLUMN (v1.2):
      1. Anomalies (Batman > Timeout > IRR)
      2. DAD quality (si POOR, descartar)
      3. SNR (si ratio > 1.5x)
      4. Pearson (warning < 0.990)
      5. Àrea diff (warning > 15%)
      6. DAD drift (preferir menys deriva)
      7. Alçada (tiebreaker)

    BP:
      1. Batman
      2. R² status (VALID > CHECK > INVALID)
      3. R² valor (bi-gaussiana)
      4. SNR (tiebreaker)
      + Pearson/Àrea/DAD generen warnings

    Usat per: DOCtor_C v1.3, DOCtor_BP v1.7, HPSEC_Suite

[2026-01-26 xx:xx] DOCtor_C.py v1.3 - USA HPSEC_REPLICA
    Integració amb hpsec_replica.py per selecció de rèpliques.
    - evaluate_replica() substitueix deteccions manuals
    - select_best_replica() importat de hpsec_replica
    - compare_replicas() per Pearson/àrea

[2026-01-26 xx:xx] DOCtor_BP.py v1.7 - USA HPSEC_REPLICA
    Integració amb hpsec_replica.py per selecció de rèpliques.
    - select_best_replica() importat de hpsec_replica (mètode BP)
    - compare_replicas() per Pearson/àrea
    - make_eval() helper per convertir analysis a format eval
    - Criteris BP: R² status > R² valor > SNR

[2026-01-26 xx:xx] DOCtor_C.py v1.2 - SIMPLIFICACIÓ DETECCIÓ
    Eliminades deteccions que no funcionen bé:
    - detect_timeout() local (mesetes) -> ara usa hpsec_core.detect_timeout (dt intervals)
    - detect_ears() (orelletes) - ~95 línies
    - calc_monotonicity() - ~50 línies
    - detect_peak_problem() (Regla D) - ~35 línies
    Simplificat select_best_replica(): només Batman + Alçada
    Detecció final: Batman + IRR + Timeout (dt intervals hpsec_core)

[2026-01-26 23:30] DOCtor_C.py v1.1 - AMORPHOUS ELIMINAT
    Eliminada detecció amorphous (precària, molts FP).
    Eliminat: detect_amorphous(), detect_amorphous_on_peak(),
              validate_amorphous_with_replicates(), calc_smoothness()
    Total: ~685 línies eliminades (~757 línies netes)
    Detecció ara: timeout (dt intervals), batman, irregular

[2026-01-26 22:00] hpsec_consolidate.py - TIMEOUT DETECTION
    Afegida detecció automàtica de timeouts TOC per cadència dades.
    Noves funcions: detect_doc_timeouts(), format_timeout_status()
    Modificades: extract_doc_from_masterfile/master(), write_consolidated_excel()
    Output: TOC_Timeout_* camps al full ID dels consolidats
    Warnings: alertes durant consolidació per timeouts en zona crítica

[2026-01-26 04:15] hpsec_migrate_master.py - UNIFICAT
    Creació de MasterFiles des de rawdata v11/v12.
    API: migrate_single(), migrate_batch(), find_seq_folders()
    CLI: --all (totes), --list (llistar), <carpeta> (una)
    Integra: regenerate_toc_calc.py + hpsec_unify_masterfiles.py (eliminats)

[2025-01-24 23:45] hpsec_consolidate.py - Consolidació SEQ
    Llegeix MasterFile + Export3D, genera fitxers consolidats.
    Suporta DUAL (Direct+UIB), COLUMN i BP.

[2025-01-24 23:25] hpsec_unify_masterfiles.py - ELIMINAT (integrat a migrate_master)
    Unificava estructura de fulls a format canònic.

[2025-01-24] regenerate_toc_calc.py - ELIMINAT (integrat a migrate_master)
    Regenerava full 4-TOC_CALC amb Sample mapping.

[2026-01-26 xx:xx] HPSEC_Suite.py - USA HPSEC_REPLICA
    _evaluate_replica() ara usa evaluate_replica_unified de hpsec_replica.
    Funcions locals detect_timeout, detect_batman, detect_ears marcades DEPRECATED.
    _select_best_replica() simplificat (eliminat n_ears comparison).

[2025-01-xx] hpsec_calibrate.py - Calibració KHP
    Anàlisi KHP, cerca automàtica, gestió historial CALDATA.

[2025-01-xx] hpsec_replica.py - Selecció de rèpliques
    Single Source of Truth: evaluate_replica, select_best_replica, compare_replicas

[2025-01-xx] hpsec_reports.py - Generació PDFs
    Reports consolidació i cromatogrames.

[2025-01-xx] hpsec_core.py - Funcions matemàtiques
    Bi-gaussiana, detecció batman, reparació paràbola, SNR, R².

[2025-01-xx] hpsec_utils.py - Utilitats generals
    Baseline, detecció pics, normalització, helpers GUI.

[2025-01-xx] analyze_khp_alignment.py - Anàlisi alineació KHP (WIP)
    Compara shift DAD vs DOC per verificar FLUSH_TIME.

================================================================================

Revisio de Doctor_C

[RESOLT 2026-01-26] EX1L2503_258 R1 Amorphous OK R2 Amorphous per raó incorrecte.
  - Detecció amorphous era precària i generava molts falsos positius
  - SOLUCIÓ: Eliminada detecció amorphous a DOCtor_C v1.1
  - Ara s'utilitza només timeout via dt intervals (més robust)

================================================================================
CHANGELOG / HISTORIAL D'ACCIONS
================================================================================

2026-01-26 - NETEJA HPSEC_Suite.py
--------------------------------------------------------------------------------
[DARRERA ACCIO]

Eliminades funcions duplicades i deprecated (~450 línies):

FUNCIONS ELIMINADES (importades de mòduls):
  - llegir_doc_uib, llegir_dad_export3d → hpsec_consolidate
  - netejar_nom_uib, trobar_excel_mestre → hpsec_consolidate
  - extract_doc_from_master, process_dad → hpsec_consolidate
  - baseline_stats → hpsec_utils
  - baseline_stats_time → hpsec_calibrate
  - detect_main_peak → hpsec_consolidate
  - netejar_baseline (duplicat) → eliminat

FUNCIONS DEPRECATED ELIMINADES:
  - detect_batman → usar hpsec_replica.evaluate_replica()
  - detect_timeout → usar hpsec_replica.evaluate_replica()
  - detect_ears → no funcionava, eliminat

IMPORTS AFEGITS:
  - from hpsec_utils import baseline_stats
  - from hpsec_replica import evaluate_dad, evaluate_dad_multi, compare_doc_dad

Resultat: 7244 línies → 6793 línies (-451 línies, -6%)

PENDENT:
  - avaluar_qualitat_dad_replica() i seleccionar_millor_dad() podrien
    migrar a hpsec_replica però requereixen més refactoring

--------------------------------------------------------------------------------

2026-01-26 - SIMPLIFICACIÓ DETECCIÓ (DOCtor_C v1.2)
--------------------------------------------------------------------------------

Objectiu: Mantenir només les deteccions que funcionen bé.

Problema:
  - detect_timeout() local (mesetes) era molt sensible a falsos positius
  - detect_ears() no funcionava bé en la pràctica
  - calc_monotonicity() i detect_peak_problem() (Regla D) no aporten valor
  - El mètode dt intervals de hpsec_core és molt més robust per timeouts

Accions realitzades:
  1. Creat branch refactor/simplify-doctorc-detection
  2. Eliminades funcions:
     - detect_timeout() local (mesetes) - ~145 línies
     - detect_ears() - ~95 línies
     - calc_monotonicity() - ~50 línies
     - detect_peak_problem() (Regla D) - ~35 línies
  3. Eliminats camps: has_stop, stop_cv, stop_info, mono_*, ears
  4. Actualitzat detect_timeout a usar hpsec_core.detect_timeout (dt intervals)
  5. Simplificat select_best_replica(): només Batman + Alçada
  6. Actualitzat docstring a v1.2 amb changelog

Resultat:
  - DOCtor_C.py ara ~1550 línies (abans ~1900 v1.1)
  - Detecció molt més simple i robusta:
    * Batman (via detect_peak_anomaly)
    * IRR (smoothness < 18% via detect_peak_anomaly)
    * Timeout (via hpsec_core.detect_timeout - dt intervals)

--------------------------------------------------------------------------------

2026-01-26 - ELIMINACIÓ DETECCIÓ AMORPHOUS (DOCtor_C v1.1)
--------------------------------------------------------------------------------

Objectiu: Simplificar DOCtor_C eliminant detecció amorphous precària.

Problema:
  - detect_amorphous() generava molts falsos positius
  - Algoritme complex (segments lineals + angles) massa sensible
  - validate_amorphous_with_replicates() afegia complexitat sense benefici
  - Timeout via dt intervals és molt més robust i fiable

Accions realitzades:
  1. Creat branch refactor/remove-amorphous-column
  2. Eliminades funcions (~685 línies):
     - detect_amorphous() - ~370 línies
     - detect_amorphous_on_peak() - ~70 línies
     - validate_amorphous_with_replicates() - ~190 línies
     - calc_smoothness() - ~55 línies
  3. Eliminats camps: is_amorphous, amorphous_info, amorphous_angles, n_amorphous
  4. Eliminada visualització AMORPHOUS (text box, labels)
  5. Simplificat has_issues: ara is_anomaly OR has_stop OR mono_total < llindar
  6. Actualitzat docstring a v1.1 amb changelog
  7. Commit i merge a main

Resultat:
  - Net: 789 línies eliminades, 32 insercions
  - DOCtor_C.py ara ~1900 línies (abans ~2650)
  - Detecció més robusta i menys falsos positius

Detecció ara basada en:
  - Timeout via dt intervals (primari)
  - Batman (pic-vall-pic al cim)
  - Irregular (smoothness < 18% via detect_peak_anomaly)

--------------------------------------------------------------------------------

2026-01-26 - ANALISI IMPACTE TIMEOUT TOC (COMPLETAT)
--------------------------------------------------------------------------------

Objectiu: Quantificar l'impacte real dels timeouts en la qualitat de les dades.

Anàlisi realitzada (331 mostres DUAL: 178 Column + 153 BP):
  - Mostres amb timeout: 198 (60%)
  - CRITICAL (zona HS): 11
  - WARNING (BioP/BB/SB): 109
  - INFO (LMW/post-run): 78

Resultats principals:
  - Pearson Direct vs UIB global: 0.988-0.993 (excel·lent)
  - Zona HS (més sensible): r = 0.983
  - Els timeouts NO invaliden les dades

Durada zona afectada (RMSE analysis):
  - PRE-timeout: ~0.5 min (RMSE elevat 41%)
  - Timeout: ~1.2 min (74s gap)
  - POST-timeout: ~1.0 min (estabilització)
  - TOTAL: ~2.5-3 min afectats

Fitxers generats:
  - PROVES/timeout_impact/all_samples_v3.pdf (331 pàgines, totes les mostres)
  - PROVES/timeout_impact/informe_timeout_resum.png
  - PROVES/timeout_impact/informe_timeout_perfil.png
  - PROVES/timeout_impact/informe_timeout_duracio.png
  - PROVES/timeout_impact/timeout_impact_metrics.csv

--------------------------------------------------------------------------------

2026-01-26 - DETECCIO TIMEOUTS TOC

Objectiu: Detectar automàticament els timeouts per recàrrega de xeringues TOC
         i avisar quan afecten zones crítiques del cromatograma.

Anàlisi prèvia:
  - Cicle recàrrega: 77.2 min (verificat amb 6 seqüències)
  - Timeout: ~74 segons
  - Durada mostra: 78.65 min (constant, CV=0.013%)
  - Deriva: 1.45 min per mostra (el timeout "retrocedeix")
  - Model predictiu: r = 0.9982, error mitjà 1.2%

Implementació a hpsec_consolidate.py (+426 línies):
  1. TIMEOUT_CONFIG - Configuració zones i severitats
  2. detect_doc_timeouts() - Detecta timeouts per cadència (dt > 60s)
  3. format_timeout_status() - Formata estat per consolidat
  4. extract_doc_from_masterfile() - Ara retorna (df, timeout_info)
  5. extract_doc_from_master() - Ara retorna (df, timeout_info)
  6. write_consolidated_excel() - Nou paràmetre timeout_info
  7. Actualitzades totes les crides a funcions d'extracció

Severitats per zona:
  - CRITICAL: HS (18-23 min) - Zona substàncies húmiques
  - WARNING: BioP, BB, SB (0-40 min) - Zones crítiques
  - INFO: LMW (40-70 min), RUN_START (<1 min)
  - OK: POST_RUN (>70 min) - Zona ideal

Output al full ID:
  TOC_Timeout_Detected, TOC_Timeout_Count, TOC_Timeout_Severity,
  TOC_Timeout_N (detalls), TOC_Zones_Affected, TOC_Dt_Median/Max_sec

Documentació generada:
  - PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md
  - PROVES/dual_profiles/MODEL_PREDICTIU_TIMEOUT.md
  - PROVES/dual_profiles/analisi_completa_T0.png

Recomanació operativa:
  Si es canvia durada mostra a 77.2 min + espera 3-5 min post-flush:
  → 100% timeouts en zona post-run (sense impacte)

--------------------------------------------------------------------------------

2025-01-24 - UNIFICACIO MASTERFILES
--------------------------------------------------------------------------------

Objectiu: Unificar l'estructura de tots els MasterFiles existents a Dades2

Problema detectat:
  - 4 variants d'estructura diferents
  - Noms de fulls inconsistents (TOC_CALC vs 3-TOC_CALC vs 4-TOC_CALC)
  - Ordre de fulls variable (TOC_CALC abans o després de DAD_KHP)
  - 2 fitxers amb 3-SEQ_DATA redundant

Accions realitzades:
  1. Anàlisi de 38 MasterFiles per identificar variants
  2. Definició estructura canònica:
     0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP (opcional), 4-TOC_CALC (sempre al final)
  3. Creació hpsec_unify_masterfiles.py
  4. Execució unificació amb --apply (38 fitxers processats)
  5. Regeneració 4-TOC_CALC per 265_SEQ i 277_SEQ_BP (no en tenien)

Resultat:
  - 29 fitxers: 0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP, 4-TOC_CALC
  - 9 fitxers:  0-INFO, 1-HPLC-SEQ, 2-TOC, 4-TOC_CALC (sense KHP)
  - Backups creats a cada carpeta (*_backup_YYYYMMDD_HHMMSS.xlsx)

Fitxers nous/modificats:
  - hpsec_unify_masterfiles.py (NOU)
  - 38 MasterFiles a Dades2/ (MODIFICATS)
  - 38 backups creats 