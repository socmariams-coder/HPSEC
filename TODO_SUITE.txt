================================================================================
TODO - SUITE HPSEC
================================================================================

################################################################################
PRINCIPIS D'ARQUITECTURA
################################################################################

PRINCIPI 1: JSON COMPLET > LECTURA EXCEL
  Qualsevol canvi a la GUI que requereixi dades, verificar primer si √©s millor
  afegir els camps al JSON (backend) en lloc de llegir Excels (lent).

  CORRECTE:  consolidation.json cont√© TOTA la info ‚Üí GUI llegeix 1 fitxer
  INCORRECTE: GUI llegeix N fitxers Excel per obtenir info addicional

  Motius:
  - Efici√®ncia: 1 JSON vs N Excels (pandas)
  - Consist√®ncia: tota la info centralitzada
  - Menys depend√®ncies a la GUI

################################################################################
üî¥ PRIORITARI - NAMING FITXERS UIB/DAD
################################################################################

[ ] PARLAR AMB T√àCNICS: Naming fitxers exportats
    PROBLEMA: Els noms dels fitxers UIB/DAD (cromat√≤graf) no coincideixen amb MasterFile
    EXEMPLE: MasterFile t√© "NaOH 0.1mM_1", fitxer es diu "NAOH 0.1MM_UIB1B.CSV"
    IMPACTE: Fitxers queden orfes, cal assignaci√≥ manual

    SOLUCI√ì PROPOSADA: Identificar mostres per Line# a l'exportar
    - Si el cromat√≤graf pot incloure Line# al nom del fitxer ‚Üí matching garantit
    - Format ideal: "L01_MQ_R1_UIB1B.CSV" (L=Line, R=Replica)

    WORKAROUND ACTUAL:
    - GUI permet assignaci√≥ manual de fitxers orfes (doble-clic)
    - Bot√≥ "Actualitzar" per refrescar comptador orfes
    - BUG PENDENT: La llista d'orfes no s'actualitza correctament despr√©s d'assignacions

################################################################################
üü° PENDENT - STATUS I COMENTARIS MOSTRES
################################################################################

[ ] AFEGIR CAMP STATUS A MOSTRES
    IDEA: Permetre etiquetar mostres amb status com:
    - NO CONFORME
    - AN√íMALA
    - REVISAR
    - OK

    OPCIONS:
    a) Camp desplegable amb opcions predefinides
    b) Columna addicional amb comentaris lliures
    c) Combinaci√≥ d'ambd√≥s (status + comentari)

    UBICACI√ì: Panell d'importaci√≥ o revisi√≥?

    IMPACTE:
    - Cal modificar estructura JSON/manifest
    - Cal afegir columna a taula de mostres
    - Filtrar per status a la revisi√≥?

################################################################################
BUGS CONSOLIDACI√ì (hpsec_consolidate.py)
################################################################################

[x] FIXAT: Files DOC duplicades entre r√®pliques (matching parcial)
    AFECTADES: 269B_SEQ (POST_O3), 270_SEQ_BP (POST_O3)
    CAUSA: El matching parcial agafava la primera coincid√®ncia, ignorant r√®plica
    SOLUCI√ì: Nou algoritme de matching:
      1. Coincid√®ncia exacta (mostra_R#)
      2. Coincid√®ncia normalitzada (ignorar espais/guions)
      3. Coincid√®ncia parcial amb r√®plica correcta
    NOTA: 283_SEQ continua amb problemes perqu√® el MasterFile √©s incomplet

[ ] PENDENT: 283_SEQ - MasterFile incomplet
    PROBLEMA: Falten l√≠nies 8-12 a 1-HPLC-SEQ (FR2606, FR2607, FR2608_R1...)
    IMPACTE: Consolidaci√≥ no pot assignar files correctes a mostres faltants
    ACCI√ì: El t√®cnic ha de revisar l'equip i completar el MasterFile

[ ] BUG: Samples duplicats al JSON
    AFECTADES: 282B_SEQ, 283_SEQ, 284_SEQ_BP (NAOH_0.1MM)
    PROBLEMA: El mateix sample apareix 2 cops a consolidation.json
    CAUSA: Control samples (NaOH, MQ) apareixen m√∫ltiples cops sense distinci√≥ de bloc
    IMPACTE: Estad√≠stiques incorrectes, comptadors inflats
    SOLUCI√ì: Implementar naming amb blocs (B1, B2) per controls que es repeteixen

[x] IMPLEMENTAT: Validaci√≥ 1-HPLC-SEQ (validate_hplc_seq)
    Funci√≥ nova que verifica integritat del MasterFile:
      * EMPTY_HPLC_SEQ: Fulla buida o inexistent
      * MISSING_LINES: Line# no seq√ºencial (detecta l√≠nies faltants)
      * MISSING_FILES: Entrades MasterFile sense fitxer UIB
      * INCOMPLETE_FIRST_SAMPLES: Primeres mostres amb poc punts (mem√≤ria DOC esgotada)
    S'executa autom√†ticament durant consolidate_sequence()
    Resultats guardats a consolidation.json

[x] IMPLEMENTAT: Quality check per detectar duplicats
    - generate_consolidation_summary() ara detecta:
      * DUPLICATE_ROWS (ERROR): Files compartides entre mostres diferents
      * DUPLICATE_SAMPLES (WARNING): Mateixa mostra apareix m√∫ltiples cops
    - update_consolidation_json.py tamb√© aplica el quality check
    - quality_issues array afegit al JSON per GUI
    - Errors/Warnings afegits autom√†ticament

[x] IMPLEMENTAT: Auto-migraci√≥ de formats antics
    Ara consolidate_sequence() crida migrate_single() si no troba MasterFile.
    257_SEQ i similars es migraran autom√†ticament.

################################################################################
ACCIONS PENDENTS STRS (T√®cnics)
################################################################################

[ ] 261D_SEQ_BP - Revisar dades
    PROBLEMA: La carpeta 261D_SEQ_BP cont√© fitxers incorrectes:
      - 261C_SEQ_v11.xlsx (pertany a 261C, no 261D)
      - 261_2_MasterFile.xlsx (no correspon a 261D)
    ACCI√ì: Verificar si existeixen dades reals per 261D_SEQ_BP
      - Si existeixen: crear MasterFile correcte (261D_MasterFile.xlsx)
      - Si no existeixen: eliminar carpeta o documentar com a buida

################################################################################
SESSIO EN CURS - 2026-01-28
################################################################################

TASCA ACTUAL: HPSEC Suite v3 (wizard basat en v1 + backend modular)

--------------------------------------------------------------------------------
HPSEC SUITE v3 - NOVA VERSI√ì
--------------------------------------------------------------------------------
Decisi√≥: Partir de v1 (wizard 4 passos) + backend modular de v2.

FITXERS:
  - HPSEC_Suite.py     = v1 original (6530 l√≠nies, monol√≠tica)
  - HPSEC_Suite_v2.py  = v2 (sidebar, modular per√≤ confusa)
  - HPSEC_Suite_v3.py  = v3 NOVA (wizard + modular)

ESTRUCTURA v3:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  HPSEC Suite v3.0       [SEQ: xxx]    [Repositori] [‚öô]     ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ  [1. Consolidar] ‚Üí [2. Calibrar] ‚Üí [3. QC] ‚Üí [4. Exportar] ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ   [Contingut del pas actual - UI interactiva]              ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ  [‚Üê Anterior]           Status                  [Seg√ºent ‚Üí] ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

IMPLEMENTAT v3:
  [x] Estructura wizard 4 passos
  [x] Pas 1: Consolidar (info + progr√©s + bot√≥)
  [x] Pas 2: Calibrar (info detallada + gr√†fic cromatograma + botons)
  [x] Pas 3: QC (taula interactiva + men√∫ contextual, llegeix de JSON)
  [x] Pas 4: Exportar (opcions + resum + botons)
  [x] Navegaci√≥ (Anterior/Seg√ºent + clic passos)
  [x] Detecci√≥ autom√†tica √∫ltima SEQ
  [x] Usa backend modular (hpsec_config, hpsec_consolidate, etc.)
  [x] Pas 1: Mostra info detallada (fitxers .D, UIB, DAD, mode, orfes)
  [x] Pas 1: Resum consolidaci√≥ amb estad√≠stiques (SNR, LOD, timeouts)
  [x] Pas 1: Barres de severitat timeouts (OK/INFO/WARN/CRIT)
  [x] Pas 2: Mostra info KHP completa (origen, concentraci√≥, r√®pliques)
  [x] Pas 2: Mostra resultats calibraci√≥ (factor, √†rea, RSD, shift)
  [x] Pas 2: Mostra qualitat (simetria, SNR, issues amb colors)
  [x] Pas 2: Gr√†fic cromatograma DOC amb √†rea integrada + DAD 254nm
  [x] Backend integration correcta (keys calibration.factor, khp_data.*, etc.)
  [x] Generaci√≥ CHECK/consolidation.json amb resum complet

PENDENT v3:
  [ ] Modal configuraci√≥ (bot√≥ ‚öô)
  [ ] Finestra Repositori (Calibracions + Mostres)
  [ ] Generaci√≥ gr√†fics QAQC
  [ ] Generaci√≥ PDF informe
  [ ] Testejar flux complet
  [ ] Hist√≤ric KHP funcional (bot√≥ existent, implementar di√†leg)
  [ ] EXPORT: Identificar run BP associat a COLUMN
      - Per FAIR data, cada export COLUMN necessita referenciar el seu run BP
      - Afegir camp "associated_bp_seq" a metadades d'exportaci√≥
      - Exemple: 283_SEQ_COLUMN -> associated_bp_seq = "283_SEQ_BP"
      - Important per tra√ßabilitat i reproductibilitat de dades
  [ ] CONFIG: Llista injeccions control (MQ, NaOH, etc.) amb nivell duplicats diferent
      - Les injeccions control poden tenir patrons de r√®plica/bloc diferents a les mostres
      - Fitxers com MQ1_UIB1B.CSV, MQ2_UIB1B.CSV no s'han de considerar orfes
      - Afegir a hpsec_config.py: CONTROL_INJECTIONS = ["MQ", "NAOH", "BLANK", ...]
      - Relacionat amb numeraci√≥ de blocs als fitxers resultants
  [x] PLANNING: Planificador seq√º√®ncies complet (hpsec_planner_gui.py v3.0)
      - Distingeix COLUMN vs BP
      - Tipus: SAMPLE (duplicat), KHP (duplicat), MQ (control), NaOH (neteja)
      - Timeline visual amb predicci√≥ timeouts
      - Suggeriments posici√≥ MQ/NaOH per evitar zona cr√≠tica
      - Freq√º√®ncia configurable per MQ i NaOH separadament
  [ ] PLANNING: Generar configs per BP i COLUMN simult√†niament
      - Per un mateix llistat de mostres, oferir config per ambd√≥s modes
      - Les mateixes mostres s'analitzen t√≠picament per BP i COLUMN
      - Bot√≥ "Generar ambd√≥s" per comparar durades i timeouts
      - Export JSON amb configuraci√≥ dual (COLUMN + BP)
  [ ] PLANNING: Simular seq√º√®ncia √≤ptima on timeouts cauen sempre a post-run
      - Usar timing stats de consolidation.json (pre_injection_time, interval_mean)
      - TOC_CYCLE = 77.2 min, timeout = 74 sec
      - Objectiu: calcular durada mostra i delay inicial per evitar zona cr√≠tica

--------------------------------------------------------------------------------
PIPELINE REPLICA SELECTION (2026-01-29) - COMPLETAT
--------------------------------------------------------------------------------

OBJECTIU: Implementar selecci√≥ de r√®pliques post-calibraci√≥ amb suport h√≠brid DOC/DAD

IMPLEMENTAT:
  [x] hpsec_pipeline.py - Selecci√≥ independent DOC/DAD
      - SampleResult ara t√©: selected_doc, selected_dad, selected (R1/R2/MIXED)
      - Comparativa entre r√®pliques: Pearson, √†rea, DAD quality
      - Concentracions per fracci√≥ calculades amb factor calibraci√≥
      - Par√†metres transformaci√≥ per reproductibilitat

  [x] processing_summary.json - Font √∫nica de veritat
      Estructura per mostra:
        - selected_doc, selected_dad, selected
        - comparison: {pearson, area_diff_pct}
        - areas_fraction: {BioP, HS, BB, SB, LMW, total}
        - concentration_ppm, conc_fraction
        - transformation: {shift_sec, baseline_mau, factor_used, khp_source}
        - replicas: info detallada per R1, R2 incloent dad_eval

  [x] HPSEC_Suite_v3.py - GUI passiva
      - _run_review_process() ara NOM√âS llegeix de processing_summary.json
      - NO fa processament - tot ve del JSON generat per hpsec_pipeline.py
      - Mostra selecci√≥ independent (DOC/DAD) i estat MIXED
      - Guarda resultats a self.selected_replicas per exportaci√≥

FLUX FINAL:
  hpsec_pipeline.process_sequence()
    ‚Üí _step_process() amb calibration_data
      ‚Üí _process_sample() per cada mostra
        ‚Üí Avalua r√®pliques (evaluate_replica)
        ‚Üí Compara (compare_replicas)
        ‚Üí Selecciona millor DOC i DAD independentment
        ‚Üí Calcula concentracions amb factor calibraci√≥
    ‚Üí _step_export()
      ‚Üí _create_export_summary() genera processing_summary.json

  HPSEC_Suite_v3.py
    ‚Üí _run_review_process() llegeix processing_summary.json
    ‚Üí Mostra taula amb seleccions i estat

COMMITS:
  - 14b1e80: hpsec_pipeline: Add independent DOC/DAD replica selection
  - 17b2c9d: Refactor GUI review stage to read from JSON only

--------------------------------------------------------------------------------
SUITE v3.1 - MILLORES GUI (2026-01-29)
--------------------------------------------------------------------------------

BACKEND CALIBRACI√ì:
  [x] doc_mode es llegeix correctament (DUAL/Direct/UIB)
  [x] uib_sensitivity es guarda (700/1000 ppb)
  [x] Hist√≤ric filtra per doc_mode i uib_sensitivity
  [ ] Script per actualitzar doc_mode a calibracions antigues

PAS 1 - IMPORTAR (REDISSENY):
  [ ] Assignacions incorrectes: permetre correcci√≥ manual
      - Si matching confidence < 85%, mostrar di√†leg
      - Llista de fitxers amb assignaci√≥ suggerida
      - Dropdown per reassignar manualment
      - Bot√≥ "Ignorar" per fitxers no volguts
  [ ] Fitxers orfes: moure de "Resum" a "Info Seq√º√®ncia"
      - Mostrar count a info, detall expandible
  [ ] KHP: mostrar TOTES les r√®pliques, no nom√©s una
      - Taula amb R1, R2, etc.
      - √Ärea, SNR, anomalies per cada una
      - Indicar quina s'usar√† per calibrar

PAS 2 - CALIBRAR (MILLORES):
  [ ] Si ja calibrat: mostrar info sense recalibrar
      - Bot√≥ "Recalibrar" opcional
  [ ] Mostrar totes les r√®pliques KHP amb m√®triques
      - √Ärea DOC, √Ärea A254, Ratio DOC/A254
      - SNR, Simetria, Quality score
      - Checkbox per seleccionar quines usar
  [ ] M√®tode selecci√≥: Promig vs Millor qualitat
  [ ] Gr√†fic actualitza din√†micament segons selecci√≥
  [ ] Comparaci√≥ hist√≤rica amb filtre doc_mode

--------------------------------------------------------------------------------
COMPLETAT AVUI (2026-01-28) - ABANS DE v3
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
COMPLETAT AVUI (2026-01-28)
--------------------------------------------------------------------------------
[x] hpsec_consolidate.py v1.6.0 - VALIDACI√ì + FILTRE CONTROLS:
    - v1.5.0: Sistema matching amb confian√ßa (EXACT/NORMALIZED/FUZZY)
    - v1.6.0: Filtre injeccions control (MQ, NaOH, BLANK, H2O, WASH)
    - Configurable a hpsec_config.py: control_injections.patterns[]
    - Controls no es marquen com a orfes (ignore_orphan: true)
    - Testat en 17 SEQs: 0 falsos positius baixa confian√ßa

[x] hpsec_consolidate.py v1.4.0 - CONSOLIDATION.JSON:
    Nova funcionalitat: Generaci√≥ de CHECK/consolidation.json amb resum complet.

    Noves funcions:
      - _collect_sample_stats(): Recull estad√≠stiques per mostra
      - generate_consolidation_summary(): Genera diccionari resum
      - save_consolidation_summary(): Guarda JSON a CHECK/

    Contingut consolidation.json:
      - meta: seq, date, method, mode, script_version
      - counts: total_samples, khp_samples, control_samples, regular_samples
      - alignment: shift_uib, shift_direct, source
      - timeouts: severity_counts, critical_samples
      - quality: snr_direct/uib (min/median/max), lod_direct/uib_mau
      - samples: llista detallada per mostra

    Millores:
      - Filtre valors extrems SNR (>10000) i noise (<0.01)
      - Corregit bug: result["processed"] -> result["processed_count"]

[x] HPSEC_Suite_v3.py - GUI RESUM CONSOLIDACI√ì:
    Nou frame "Resum Consolidaci√≥" al pas 1 amb:
      - Comptadors: mostres, KHP, controls
      - Alineaci√≥: shifts UIB/Direct, font
      - SNR: mediana i m√≠nim
      - LOD: Direct i UIB (mAU)
      - Barres timeouts per severitat amb colors
      - Mostres cr√≠tiques (si CRITICAL)
      - Avisos importants

    Nova funci√≥:
      - _show_consolidation_summary(): Mostra resum a la GUI

    Canvis:
      - _consolidation_done(): Carrega i mostra resum
      - _analyze_folder(): Carrega resum existent de consolidation.json

[x] Afegir "paths" a hpsec_config.py:
    - data_folder: "C:/Users/Lequia/Desktop/Dades2"
    - Centralitza path del repositori

[x] Actualitzar HPSEC_Suite_v2.py per usar config paths:
    - L√≠nia 2048: ara usa self.config.get("paths", "data_folder")

[x] Afegir SNR, LOD, LOQ i baseline noise a consolidats (hpsec_consolidate.py v1.3.0):
    - Nova funci√≥ calculate_snr_info()
    - Camps afegits al full ID:
      * SNR_Direct, SNR_UIB
      * Baseline_Noise_Direct_mAU, Baseline_Noise_UIB_mAU
      * LOD_Direct_mAU, LOD_UIB_mAU (= 3 √ó noise)
      * LOQ_Direct_mAU, LOQ_UIB_mAU (= 10 √ó noise)
    - Nou par√†metre snr_info a write_consolidated_excel()
    - Les 3 crides a write_consolidated_excel() actualitzades

--------------------------------------------------------------------------------
GUI v2.1 - REDISSENY ACORDAT (2026-01-28)
--------------------------------------------------------------------------------

ESTRUCTURA FINAL (4 p√†gines + modal config):

  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  Processar ‚îÇ SEQ Status ‚îÇ Repositori ‚îÇ Eines ‚îÇ    [‚öô]  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  1. PROCESSAR
     - Pipeline autom√†tic (Migrar ‚Üí Consolidar ‚Üí Calibrar ‚Üí Processar)
     - Log en temps real (streaming, sense pauses)
     - Nom√©s para si error
     - Al final: resum r√†pid + bot√≥ obrir CHECK/
     - Auto-detecta darrera SEQ
     - Exportar: PENDENT DEFINIR (m√∫ltiples opcions + ZIP)

  2. SEQ STATUS (abans "Repositori")
     - Llista totes les SEQs amb estat (MF/Con/Cal/Proc)
     - Batch processing (seleccionar m√∫ltiples)
     - Reprocessar SEQs antigues
     - Icones amb llegenda

  3. REPOSITORI (abans "Hist√≤ric")
     - Tab Calibracions: KHP_History.json
       * Taula amb factor, r¬≤, data, estat
       * Gr√†fic evoluci√≥ temporal
       * Marcar outliers
       * Exportar Excel
     - Tab Mostres: Samples_History.json
       * Totes les mostres processades
       * Cercar, filtrar
       * Estad√≠stiques per mostra
       * Exportar Excel

  4. EINES
     - Planificador T0 (optimitzar seq√º√®ncies per timeouts)
     - UIB vs Direct (comparar senyals)
     - Altres eines a revisar

  5. CONFIG (modal, icona ‚öô a cap√ßalera)
     - Paths
     - Thresholds
     - Wavelengths
     - etc.

TASQUES IMPLEMENTACI√ì:
  [x] Reestructurar navegaci√≥ (4 p√†gines + modal config)
  [x] Config: convertir a modal (icona ‚öô a sidebar)
  [x] Repositori: estructura tab Calibracions/Mostres
  [x] Reanomenar etapa "Processar" a "QC" (evita confusi√≥ amb p√†gina)
  [x] Fix: SEQs ja processades - ara mostra di√†leg confirmaci√≥ (no bloqueja)
  [x] Processar: afegir taula QC interactiva (com v1)
      - Columnes: Mostra, Estat, DOC R, DOC Œî%, Sel DOC, DAD Qual, Sel DAD
      - Doble clic per obrir gr√†fic QAQC
      - Clic dret per canviar selecci√≥ DOC/DAD
      - Tags de color: OK (verd), WARN (taronja), FAIL (vermell), MODIFIED (blau)
  [x] Processar: panell resum amb stats (fitxers, mostres, KHP, factor)
  [x] Processar: log detall col¬∑lapsable
  [x] hpsec_pipeline.py: reanomenar step "processar" a "qc"
  [ ] Processar: obrir CHECK/ al final
  [ ] SEQ Status: batch processing funcional
  [ ] Repositori: poblar tab Calibracions des de KHP_History.json
  [ ] Repositori: poblar tab Mostres des de Samples_History.json
  [ ] Eines: revisar funcionalitats necess√†ries

--------------------------------------------------------------------------------
PENDENT
--------------------------------------------------------------------------------
[ ] RECONSOLIDAR TOTES LES SEQ√ú√àNCIES:
    - Afegeix: timeout info, SNR, LOD, LOQ, baseline noise
    - Executar quan sigui convenient (proc√©s llarg)
    - Considerar fer-ho en batch overnight

--------------------------------------------------------------------------------
SESSIO ANTERIOR - 2026-01-26
--------------------------------------------------------------------------------

TASCA ANTERIOR: HPSEC Suite v2 - GUI Professional

--------------------------------------------------------------------------------
GUI SUITE v2 - IMPLEMENTAT
--------------------------------------------------------------------------------
[x] Nova estructura GUI:
    - Planificar SEQ: Optimitzar T0 per evitar timeouts en zones cr√≠tiques
    - Processar SEQ: Processar seq√º√®ncia (auto-detecta darrera o selecci√≥ manual)
    - Estat Repositori: Visi√≥ general de totes les SEQs i el seu estat
    - Eines: Comparacions, diagn√≤stic, planificador timeout
    - Configuraci√≥: Par√†metres centralitzats

[x] Detecci√≥ autom√†tica d'estat per SEQ:
    - MasterFile: existeix o cal migrar
    - Consolidat: carpeta Resultats_Consolidats
    - Calibrat: CHECK/calibration.json
    - Processat: CHECK/processing_summary.json
    - Versi√≥: compara versi√≥ processament vs versi√≥ actual pipeline

[x] Tracking de versi√≥ del pipeline:
    - PIPELINE_VERSION a hpsec_pipeline.py
    - Es guarda a processing_summary.json
    - GUI detecta si cal reprocessar per canvi de versi√≥

[x] M√≤duls nous creats:
    - hpsec_config.py: Gesti√≥ centralitzada configuraci√≥ (JSON)
    - hpsec_gui.py: Components GUI moderns (ModernCard, ProgressPanel, etc.)
    - hpsec_planner.py: Planificador seq√º√®ncies per optimitzar timeout TOC
    - hpsec_pipeline.py: Pipeline integrat (migrar‚Üíconsolidar‚Üícalibrar‚Üíprocessar‚Üíexportar)
    - HPSEC_Suite_v2.py: Nova GUI professional

--------------------------------------------------------------------------------
GUI SUITE v2 - ARREGLAT (2026-01-26)
--------------------------------------------------------------------------------
[x] Bug cr√≠tic _create_repositori_page:
    - Codi botons i "return page" estaven dins _on_repo_selection_change
    - Arreglat: la funci√≥ ara retorna correctament el frame page
    - Navegaci√≥ entre p√†gines ara funciona correctament

[x] Mida finestra redu√Øda:
    - Mida inicial: 700x450 (era 800x500)
    - Mida m√≠nima: 600x400 (era 700x450)

--------------------------------------------------------------------------------
GUI SUITE v2 - FINESTRES ACTUALITZADES (2026-01-27)
--------------------------------------------------------------------------------
[x] FINESTRA REDIMENSIONADA (2026-01-27):
    - Mida inicial: 70% pantalla (m√†x 900x650)
    - Mida m√≠nima: 600x450
    - Sidebar: 70px amb icones i text
    - Fonts: 9-10pt (llegibles)

[x] PLANIFICAR SEQ - TAULA DETALLADA:
    - Mostra TOTES les mostres amb timeout previst
    - Columnes: Mostra | Timeout | Zona | Severitat | Descripci√≥
    - Estad√≠stiques per severitat (CRITICAL, WARNING, INFO, OK)
    - Resum per zones amb comptadors

[x] PROCESSAR SEQ - PIPELINE PAS A PAS (2026-01-27):
    - REDISSENYAT: Ara √©s pas a pas amb confirmaci√≥ de l'usuari
    - L'usuari ha de fer clic "Seg√ºent" despr√©s de cada etapa
    - Errors EXPL√çCITS amb traceback complet
    - Cada etapa mostra detalls espec√≠fics (fitxers, factor, mostres...)
    - Botons: Iniciar | Seg√ºent | Aturar | Obrir Resultats
    - Si error: opci√≥ de reintentar o saltar etapa
    - Funcions noves a hpsec_pipeline.py:
        * run_migration_step()
        * run_consolidation_step()
        * run_calibration_step()
        * run_processing_step()
        * run_export_step()

[x] CONSOLIDAR - MISSATGES MILLORATS (2026-01-27):
    - Mostra fitxers UIB i DAD trobats expl√≠citament
    - Si ja consolidat: "Ja consolidat (X fitxers existents)"
    - Si no troba fitxers: explica on ha buscat (CSV/, Export3D/)
    - Mostra MasterFile si existeix
    - Detalla mostres consolidades vs fitxers font

    P√†gines pendents de revisar visualment:
    [ ] Repositori
    [ ] Eines
    [ ] Config

--------------------------------------------------------------------------------
GUI SUITE v2 - PENDENT
--------------------------------------------------------------------------------
[ ] FINESTRA - MILLORES ADDICIONALS:
    - Guardar √∫ltima mida/posici√≥ a config
    - Si encara √©s massa gran per algunes pantalles, considerar scroll

[ ] REPOSITORI A CONFIG:
    - Moure path "C:/Users/Lequia/Desktop/Dades2" a hpsec_config.py
    - Permetre canviar des de GUI (p√†gina Config)
    - Validar que existeix abans d'escanejar

[ ] SHAREPOINT/TEAMS:
    - Opci√≥ 1 (Recomanada): OneDrive sync ‚Üí carpeta local
    - Opci√≥ 2: Mappejar unitat de xarxa (requereix VPN fora UdG)
    - Opci√≥ 3: Microsoft Graph API (complex, auth OAuth2, lent)
    - Opci√≥ 4: WebDAV mount (pot ser lent amb Excels grans)
    - Opci√≥ 5: rclone mount (requereix instal¬∑lar rclone)
    - DECISI√ì PENDENT: quin m√®tode implementar?

[ ] REANOMENAR MASTERFILES SEGONS ESTAT:
    - Format proposat (pendent decisi√≥):
      * XXX_MasterFile.xlsx     ‚Üí migrat (raw)
      * XXX_MasterFile_C.xlsx   ‚Üí consolidat
      * XXX_MasterFile_Cal.xlsx ‚Üí calibrat
      * XXX_MasterFile_P.xlsx   ‚Üí processat
    - Permet veure estat sense obrir fitxer
    - Requereix actualitzar totes les funcions que busquen MasterFile

[ ] BATCH PROCESSING:
    - Implementar "Processar Totes Pendents" a Estat Repositori
    - Progress bar global + per SEQ
    - Log de resultats

[ ] EINES PENDENTS D'INTEGRAR:
    - Comparaci√≥ r√®pliques (compare_replicas_direct.py?)
    - Control charts (generate_control_charts.py)
    - [x] Planificador timeout (hpsec_planner.py) - INTEGRAT a p√†gina "Planificar SEQ"

[ ] PLANIFICADOR SEQ - MILLORES:
    - Adaptar per seq√º√®ncies BYPASS (diferents zones cr√≠tiques, durades)
    - Afegir visualitzaci√≥ gr√†fica dels timeouts predits
    - Opci√≥ d'exportar pla a PDF/Excel

--------------------------------------------------------------------------------
TASCA ANTERIOR: Detecci√≥ autom√†tica de timeouts TOC

COMPLETAT AVUI (2026-01-26):
  [x] An√†lisi cicle rec√†rrega xeringues TOC:
      - Cicle: 77.2 min (1140 mesures √ó ~4.06s)
      - Timeout: 74 segons
      - Durada mostra HPLC: 78.65 min
      - Deriva per mostra: 1.45 min (timeout "retrocedeix")

  [x] Model predictiu de timeouts:
      - F√≥rmula: Pos_timeout(N) = T0 - (N-1) √ó 1.45 (mod 77.2)
      - Verificat amb 6 seq√º√®ncies: r = 0.9982, error mitj√† 1.2%
      - Documentat a: PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md

  [x] Detecci√≥ autom√†tica timeouts a hpsec_consolidate.py:
      - Nova configuraci√≥ TIMEOUT_CONFIG (zones i severitats)
      - Nova funci√≥ detect_doc_timeouts() - detecta per cad√®ncia dades
      - Nova funci√≥ format_timeout_status()
      - Modificades extract_doc_from_masterfile/master() - retornen timeout_info
      - Modificada write_consolidated_excel() - escriu timeout info a ID
      - Warnings durant consolidaci√≥ per timeouts en zona cr√≠tica

  [x] Nivells de severitat implementats:
      | Zona      | Rang (min) | Severitat |
      |-----------|------------|-----------|
      | RUN_START | < 1        | INFO      |
      | BioP      | 0-18       | WARNING   |
      | HS        | 18-23      | CRITICAL  |
      | BB        | 23-30      | WARNING   |
      | SB        | 30-40      | WARNING   |
      | LMW       | 40-70      | INFO      |
      | POST_RUN  | > 70       | OK        |

  [x] Output al full ID dels consolidats:
      - TOC_Timeout_Detected: YES/NO
      - TOC_Timeout_Count: nombre de timeouts
      - TOC_Timeout_Severity: OK/INFO/WARNING/CRITICAL
      - TOC_Timeout_N: detalls (posici√≥, duraci√≥, zona)
      - TOC_Zones_Affected: zones amb timeout
      - TOC_Dt_Median_sec / TOC_Dt_Max_sec

  [x] REFACTORING HPSEC_Suite.py i hpsec_replica.py (2026-01-26):

      hpsec_replica.py v1.2:
        - Afegida avaluaci√≥ DAD (evaluate_dad, evaluate_dad_multi)
        - Afegida comparaci√≥ DOC-DAD (compare_doc_dad)
        - Afegida compare_replicas_full() per comparaci√≥ completa
        - SNR i Pearson actius per selecci√≥ COLUMN (abans nom√©s BP)
        - Nous thresholds: DAD_DRIFT_WARNING/CRITICAL, DAD_DOC_CORR

      HPSEC_Suite.py optimitzat (7244 ‚Üí 6530 l√≠nies, -714 l√≠nies):
        - Eliminat avaluar_qualitat_dad() (ara usa evaluate_dad)
        - Eliminat calcular_roughness() (duplicat d'avaluar_qualitat_doc)
        - Eliminat analyze_sample_areas() (importa de hpsec_consolidate)
        - Eliminat write_consolidated_excel() (importa de hpsec_consolidate)
        - Eliminat get_baseline_correction() (importa de hpsec_consolidate)
        - Eliminat apply_smoothing() (importa de hpsec_consolidate)
        - Refactoritzat avaluar_qualitat_dad_replica() per usar evaluate_dad
        - Refactoritzat seleccionar_millor_dad() amb l√≤gica millorada

PENDENT:
  [ ] Reconsolidar totes les seq√º√®ncies per afegir info timeout
  [ ] Generar report resum de timeouts per seq√º√®ncia
  [ ] Considerar canvi durada mostra a 77.2 min (elimina deriva)

  [x] AFEGIR SNR i LOD A CONSOLIDATS (IMPLEMENTAT 2026-01-28):
      An√†lisi realitzada (156 mostres DUAL):
        - Direct t√© millor LOD que UIB (1.24 vs 1.85 mAU a 700 ppb)
        - 700 ppb t√© millor LOD que 1000 ppb (1.85 vs 3.47 mAU)
        - El canvi a 1000 ppb (SEQ‚â•275) va augmentar soroll 2.4x

      Per mostra (afegir al full ID del consolidat):
        - SNR_UIB, SNR_Direct
        - Baseline_Noise_UIB, Baseline_Noise_Direct (mAU)

      Per seq√º√®ncia (afegir a MasterFile o JSON):
        - LOD_UIB, LOD_Direct (= 3 √ó median baseline noise)
        - LOQ_UIB, LOQ_Direct (= 10 √ó median baseline noise)
        - Sensitivity_ppb (700 o 1000)

      Documentaci√≥:
        - PROVES/uib_sensitivity/comparacio_700_vs_1000.png
        - PROVES/uib_sensitivity/lod_snr_comparison.png
        - PROVES/uib_sensitivity/uib_sensitivity_metrics.csv

  [ ] DOCUMENTAR CANVIS SIMULTANIS SEQ 275:
      A partir de SEQ 275 es van fer DOS canvis alhora:
        1. Volum injecci√≥ Column: 100 ¬µL ‚Üí 400 ¬µL (4x)
        2. Sensibilitat UIB: 700 ppb ‚Üí 1000 ppb

      EFECTE COMBINAT OBSERVAT (no es poden separar):
        | M√®trica      | UIB    | Direct | Te√≤ric si nom√©s volum |
        |--------------|--------|--------|----------------------|
        | Peak         | 2.24x  | 3.20x  | 4x                   |
        | Area         | 1.54x  | 2.27x  | 4x                   |
        | Baseline     | 1.89x  | 2.79x  | ~1x                  |
        | SNR          | 1.08x  | 1.02x  | 4x                   |

      Senyal normalitzat per ¬µL (UIB): 0.56x
        ‚Üí Menys senyal per ¬µL injectat amb nova configuraci√≥

      CONCLUSIONS:
        - El SNR NO millora malgrat 4x m√©s volum
        - El baseline tamb√© augmenta (~2-3x), cancel¬∑lant benefici
        - No es pot saber si √©s pel volum, sensibilitat, o ambd√≥s
        - Direct escala millor que UIB (3.2x vs 2.2x)

      RECOMANACI√ì FUTURA:
        - Si es vol comparar efecte volum vs sensibilitat, caldria
          fer experiments separats (un canvi a la vegada)

      Documentaci√≥:
        - PROVES/uib_sensitivity/injection_volume_comparison.png
        - PROVES/uib_sensitivity/injection_volume_metrics.csv

  [x] REFACTORITZAR DETECCI√ì ANOMALIES (COMPLETAT 2026-01-26):
      Objectiu: Unificar tota la l√≤gica de detecci√≥ en hpsec_core.py

      FASE 1-4 COMPLETADES:
        hpsec_core.py (SINGLE SOURCE OF TRUTH):
          ‚îú‚îÄ‚îÄ detect_timeout()         ‚Üê MOGUT des de consolidate
          ‚îú‚îÄ‚îÄ detect_batman()          ‚Üê Ja existia (mantingut)
          ‚îú‚îÄ‚îÄ detect_peak_anomaly()    ‚Üê Ja existia (h√≠brid batman+smoothness)
          ‚îú‚îÄ‚îÄ detect_main_peak()       ‚Üê MOGUT des de calibrate
          ‚îú‚îÄ‚îÄ detect_all_peaks()       ‚Üê MOGUT des de calibrate
          ‚îú‚îÄ‚îÄ integrate_chromatogram() ‚Üê NOU: mode='full'|'main_peak'
          ‚îú‚îÄ‚îÄ format_timeout_status()  ‚Üê MOGUT des de consolidate
          ‚îî‚îÄ‚îÄ TIMEOUT_CONFIG           ‚Üê MOGUT des de consolidate

        hpsec_calibrate.py:
          ‚îî‚îÄ‚îÄ validate_khp_quality()   ‚Üê NOU: validaci√≥ espec√≠fica KHP
              - Multi-pic (>2 pics significatius)
              - Timeout en zona del pic
              - Batman/irregular
              - Simetria acceptable (0.5-2.0)
              - SNR > 50

        hpsec_consolidate.py:
          ‚îî‚îÄ‚îÄ import detect_timeout, format_timeout_status, TIMEOUT_CONFIG from hpsec_core
              (-185 l√≠nies eliminades)

      FASE 5 COMPLETADA:
        [x] DOCtor_C.py v1.1 - AMORPHOUS ELIMINAT (2026-01-26)
            Detecci√≥ amorphous era prec√†ria i generava molts FP.
            Timeout via dt intervals √©s m√©s robust.

            Eliminat (~685 l√≠nies):
              - detect_amorphous() (~370 l√≠nies)
              - detect_amorphous_on_peak() (~70 l√≠nies)
              - validate_amorphous_with_replicates() (~190 l√≠nies)
              - calc_smoothness() (~55 l√≠nies)
              - Tots els camps is_amorphous, amorphous_info, etc.
              - Visualitzaci√≥ i estad√≠stiques amorphous

        [x] DOCtor_C.py v1.2 - SIMPLIFICACI√ì DETECCI√ì (2026-01-26)
            Eliminades deteccions que no funcionen b√©.

            Eliminat (~325 l√≠nies addicionals):
              - detect_timeout() local mesetes (~145 l√≠nies)
              - detect_ears() (~95 l√≠nies)
              - calc_monotonicity() (~50 l√≠nies)
              - detect_peak_problem() (~35 l√≠nies)
              - Camps: has_stop, stop_*, mono_*, ears

            Detecci√≥ final basada en:
              - Batman (via detect_peak_anomaly)
              - IRR (smoothness < 18%)
              - Timeout (via hpsec_core.detect_timeout - dt intervals)

        [x] DOCtor_BP.py v1.7 - USA HPSEC_REPLICA (2026-01-26)

      DETALL COMPLET: veure PLAN_REFACTOR_DETECCIO.md

  [ ] OPTIMITZAR CROMATOGRAMES SEGONS TIMEOUT TOC:
      Basat en l'an√†lisi de 331 mostres DUAL (Direct vs UIB):

      DURACIO ZONA AFECTADA PEL TIMEOUT:
        - PRE-timeout:  ~0.5 min (xeringa buidant-se, mesures inestables)
        - Timeout gap:  ~1.2 min (74s, sense dades)
        - POST-timeout: ~1.0 min (estabilitzaci√≥ despr√©s rec√†rrega)
        - TOTAL:        ~2.5-3 min afectats

      ACCIONS A IMPLEMENTAR:
        a) Revisar hpsec_consolidate.py per marcar zona afectada completa
           - Afegir camps: TOC_Affected_Zone_Start, TOC_Affected_Zone_End
           - Calcular: t_start - 0.5 min fins t_end + 1.0 min

        b) Afegir warning si zona afectada solapa amb pics cr√≠tics
           - Usar integraci√≥ d'√†rea a zona afectada vs √†rea total
           - Flag si √†rea_afectada / √†rea_total > llindar (ex: 5%)

        c) Generar m√®triques de qualitat per zona afectada:
           - Pearson local a la zona PRE/POST
           - RMSE a la zona afectada

      RECOMANACI√ì OPERATIVA (per t√®cnics):
        - Canviar durada m√®tode HPLC de 78.65 min a 77.2 min
        - Esperar 3-5 min despr√©s del flush abans d'iniciar seq√º√®ncia
        - Resultat: 100% timeouts en zona post-run (sense impacte)

      DOCUMENTACI√ì:
        - PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md
        - PROVES/timeout_impact/informe_timeout_*.png

--------------------------------------------------------------------------------
SESSIO ANTERIOR - 2025-01-25 09:15
--------------------------------------------------------------------------------

TASCA ANTERIOR: MasterFile - Template i estrat√®gia de c√†lcul

COMPLETAT:
  [x] 23:25 - Unificaci√≥ estructura MasterFiles (38 fitxers)
      - Estructura can√≤nica: 0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP, 4-TOC_CALC
      - Script: hpsec_unify_masterfiles.py

  [x] 23:45 - Actualitzaci√≥ hpsec_consolidate.py per nou format MasterFile
      - Backup: hpsec_consolidate_backup_20250124.py
      - Compatible amb format antic (4-SEQ_DATA) i nou (4-TOC_CALC)
      - 4-TOC_CALC es calcula al vol quan es consolida (no f√≥rmules Excel)

  [x] 09:15 - Creaci√≥ Template a Dades2/Template/
      - MasterFile_Template.xlsx: Plantilla buida amb estructura
      - 256_MasterFile_EXEMPLE.xlsx: Exemple complet de refer√®ncia

ESTRATEGIA TOC_CALC:
  - NO regenerar tots els MasterFiles existents
  - 4-TOC_CALC es calcula sota demanda des de hpsec_consolidate.py
  - M√©s eficient: c√†lcul Python vs f√≥rmules Excel
  - Noves SEQs: usar Template + script d'importaci√≥

PENDENT:
  [~] Verificaci√≥ alineaci√≥ DOC-DAD amb KHP (EN CURS)
      - Usar 3-DAD_KHP del MasterFile
      - Calcular shift temporal DOC vs A254
      - Verificar impacte en mapping TOC‚Üímostra

  [ ] Propagar l√≤gica nomenclatura Sample_Bx_Ry a tots els scripts
      - Origen: _create_sample_rep() a hpsec_migrate_master.py
      - Format: Sample_B1_R1, Sample_B1_R2, Sample_B2_R1... (quan hi ha duplicats)
      - Format simple: Sample_R1, Sample_R2 (quan no hi ha duplicats)
      - Afecta: hpsec_consolidate.py, DOCtor_BP.py, DOCtor_C.py, reports

  [ ] Convenci√≥ noms MasterFile segons estat processament
      - XXX_MasterFile.xlsx     ‚Üí migrat (raw, fulls 0-4)
      - XXX_MasterFile_C.xlsx   ‚Üí consolidat (+ 5-SUMMARY)
      - XXX_MasterFile_Cal.xlsx ‚Üí calibrat (+ 6-CALIBRATION)
      - XXX_MasterFile_P.xlsx   ‚Üí processat DOCtor (+ 7-RESULTS?)
      - Cada pas reanomena el fitxer i afegeix full corresponent
      - Permet veure estat sense obrir el fitxer

  [x] Reestructurar fitxers consolidats (IMPLEMENTAT 2025-01-26):
      Nova estructura Excel amb 5 fulls:
        - ID: Identificaci√≥, fitxers, estat, processament (simplificat, sense √†rees)
        - TMAX: Temps de retenci√≥ per DOC i cada wavelength DAD
        - AREAS: √Ärees per fraccions de temps (BioP, HS, BB, SB, LMW, total)
        - DOC: Cromatograma DOC (net, raw, baseline)
        - DAD: Cromatograma DAD (totes les wavelengths)

      Fraccions de temps (time_fractions):
        - BioP: 0-18 min (Biopol√≠mers)
        - HS: 18-23 min (√Äcids h√∫mics)
        - BB: 23-30 min (Building Blocks)
        - SB: 30-40 min (Small Building blocks)
        - LMW: 40-70 min (Low Molecular Weight)

      Noms columnes en angl√®s: Field/Value, Signal, Fraction, Range

  [ ] Revisar report consolidats (HPSEC_Suite.py)
      - Adaptar generaci√≥ PDF/reports a nova estructura (TMAX, AREAS)
      - Verificar que llegeix correctament els nous fulls

  [x] Reconsolidar totes les seq√º√®ncies (COMPLETAT 2025-01-26)
      - 32/33 seq√º√®ncies OK (655 fitxers consolidats)
      - ERROR: 261D_SEQ_BP (no t√© MasterFile propi, fitxers de 261C)
      - Nova estructura amb fulls TMAX i AREAS aplicada
      NOTA: Caldr√† reprocessar quan s'estandarditzin temps i versions

  [x] BUG CORREGIT + RECONSOLIDAT: Alineaci√≥ DUAL (2026-01-26)
      PROBLEMA ORIGINAL:
        - calculate_column_alignment_shifts() buscava "DOC (mAU)"
          per√≤ fitxers DUAL tenen "DOC_Direct (mAU)"

      FIX IMPLEMENTAT (v2):
        1. Afegit llegir_dad_1a() per format DAD1A (UTF-16, tab, sense cap√ßalera)
        2. Afegit llegir_dad_amb_fallback() amb prioritat Export3D -> DAD1A
        3. Modificat alineaci√≥ per suportar format MasterFile NEW i OLD
        4. L'alineaci√≥ ara usa DAD Export3D o fallback a DAD1A per A254

      RECONSOLIDACI√ì FINAL (17 SEQs):
        - Shifts calculats correctament amb Export3D com a font DAD
        - 274_SEQ: shift_direct = -44.3s (abans era 0!)
        - 275_SEQ: shift_direct = -49.3s (abans era 0!)

      MILLORA QUALITAT PERFILS:
        - 700 ppb: Pearson 0.9501 -> 0.9838 (+0.034)
        - 1000 ppb: Pearson 0.9531 -> 0.9916 (+0.039)
        - Mostres "dolentes" (r<0.95): 53 -> 14 (-74%)
        - Correlaci√≥ N_Points eliminada (r=-0.28 -> r=0.04)

      - NOTA: 271_SEQ_BP t√© KHP anomal (4000+ mAU), usar SEQ propera per alineaci√≥

  [x] Estandarditzar l√≠mits temporals cromatogrames (IMPLEMENTAT 2026-01-26)
      - Truncar tots els cromatogrames a 70 min m√†xim
      - Configurable via DEFAULT_CONSOLIDATE_CONFIG["max_time_min"]
      - S'aplica a DOC i DAD a write_consolidated_excel()

  [x] Afegir versionat als fitxers consolidats (IMPLEMENTAT 2026-01-26)
      - Script_Version: hpsec_consolidate v1.1.0
      - Consolidation_Date: timestamp de quan es va generar
      - Permet saber amb quina versi√≥ es van processar les dades

  [x] Sistema de versions pels scripts (IMPLEMENTAT 2026-01-26)
      - __version__ = "1.1.0" a hpsec_consolidate.py
      - __version_date__ = "2026-01-26"
      - Format: MAJOR.MINOR.PATCH

  [ ] Documentar deriva DAD (QC opcional)
      - C√†lcul: mitjana(t>60) - mitjana(t<10) per cada wavelength
      - Valors t√≠pics: 0.03-0.53 mAU (petits)
      - A290 pot tenir deriva negativa
      - Flag QC si deriva > llindar (a definir)
      - Nota: deriva DOC a temps llargs pot ser senyal real (compostos)

  [ ] PENDENT: Analitzar estructura final MasterFile abans d'implementar
      - Definir fulls nous post-consolidaci√≥:
        * 5-TMAX: temps retenci√≥ per mostra (format llarg)
        * 6-AREAS: √†rees per fracci√≥ (format llarg)
        * 7-PROCESSING: baseline, deriva, versi√≥, QC
      - Decidir qu√® es guarda vs qu√® es recalcula
      - Revisar m√®todes baseline: mode_robust (DOC) vs percentile_5 (DAD)
      - Documentar subsampling DAD (factor 5)

  [ ] Crear script importaci√≥ per noves SEQs (usa Template)
  [ ] Commit canvis a git

################################################################################

[x] CONSOLIDACIO: Verificar fitxers (IMPLEMENTAT)
    - Al consolidar, comptar quants fitxers hi ha al directori origen
    - Comptar quants s'han utilitzat/processat
    - Alertar si hi ha discrepancia (ex: R12 en lloc de R2, fitxers orfes, etc.)
    - Cas detectat: FR2395_273_BP tenia R1 i R12 (error nomenclatura)

    [x] Detecci√≥ discrep√†ncies a hpsec_consolidate.py:
        - Retorna files_found, files_used, files_orphan al result["file_check"]
        - Detecta anomalies nomenclatura (R12 ‚Üí R2)
        - Genera proposed_renames amb ra√≥ i confian√ßa
        - Guarda a HPSEC_QAQC/File_Check_[SEQ].json si hi ha problemes
        - Funci√≥ apply_renames() preparada per aplicar canvis

    [ ] GUI per gestionar renames (quan s'integri a Suite):
        - Taula amb Original | Proposta | Acci√≥
        - Opcions: Rename / Ignorar / Editar manualment
        - Bot√≥ aplicar canvis

--------------------------------------------------------------------------------
ORGANITZACIO CODI
--------------------------------------------------------------------------------
[x] hpsec_core.py - Funcions compartides BP:
    - bigaussian, fit_bigaussian, check_asymmetry
    - detect_batman (artefactes al cim del pic)
    - detect_timeout (dt intervals) - timeout TOC
    - detect_peak_anomaly (batman + smoothness h√≠brid)
    - repair_with_parabola, find_tangents_and_anchors
    - calc_snr, calc_peak_area, calc_pearson, calibrate_factor
    - Constants globals (THRESH_R2_*, REPAIR_*, ASYM_*, TIMEOUT_CONFIG)

[x] hpsec_replica.py v1.2 - Selecci√≥ de r√®pliques amb DAD:
    Funcions DOC:
      - evaluate_replica(t, y, method) - avaluaci√≥ unificada
      - select_best_replica(eval1, eval2, method, dad_eval) - selecci√≥ COLUMN/BP
      - compare_replicas(t1, y1, t2, y2) - Pearson i √†rea

    Funcions DAD (NOU v1.2):
      - evaluate_dad(t, y) - deriva, soroll, SNR per wavelength
      - evaluate_dad_multi(t, dad_data) - m√∫ltiples wavelengths
      - compare_doc_dad(t_doc, y_doc, t_dad, y_dad) - correlaci√≥ DOC-DAD
      - compare_replicas_full(...) - comparaci√≥ completa DOC+DAD

    Criteris COLUMN: Batman > Timeout > IRR > DAD_POOR > SNR > DAD_drift > Al√ßada
    Criteris BP: Batman > R¬≤ status > R¬≤ valor > SNR (+DAD warnings)

    Llindars:
      - SNR_RATIO 1.5x, PEARSON_WARNING 0.990, AREA_DIFF 15/30%
      - DAD_DRIFT 1.0/3.0 mAU, DAD_NOISE 0.5 mAU, DAD_DOC_CORR 0.90/0.95
    - Usat per: DOCtor_C v1.3, DOCtor_BP v1.7, HPSEC_Suite

[x] hpsec_utils.py - Utilitats generals:
    - baseline_stats, detect_main_peak
    - detect_batman (pics dobles coeluits - columna)
    - seleccionar_carpeta, obtenir_seq, normalize_key
    - is_khp, extract_khp_conc

[x] hpsec_reports.py - M√≤dul generaci√≥ PDFs professional:
    - generate_consolidation_report(): Resum + taula punts Direct/UIB/DAD
    - generate_chromatograms_report(): R√®pliques R1|R2 juntes, ordenat
    - Ordenaci√≥: Mostres ‚Üí KHP ‚Üí Controls (MQ/NaOH)
    - Format cient√≠fic: logo, cap√ßalera minimalista, peu de p√†gina
    - 4 parells per p√†gina, eixos etiquetats
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[x] hpsec_consolidate.py - M√≤dul consolidaci√≥ extret de Suite:
    - Funcions lectura: llegir_doc_uib, llegir_dad_export3d, trobar_excel_mestre
    - Funcions processament: process_dad, detect_main_peak, analyze_sample_areas
    - Funci√≥ principal: consolidate_sequence(seq_path, config, progress_callback)
    - Funci√≥ escriptura: write_consolidated_excel()
    [x] DUAL PROTOCOL: Extreu DOC de UIB (CSV) i Direct (Excel mestre)
        - Output: time, DOC (Direct), DOC_UIB
        - Escala temps: Direct (~4 sec, real) vs UIB (~0.32 sec, fict√≠cia)
    [x] ALINEACI√ì:
        - BP: Alinea pel m√†xim de cada mostra individualment
        - COLUMN: Alinea amb KHP + A254 com a refer√®ncia
    [x] LOG QAQC (HPSEC_QAQC/Alignment_History.json):
        - Guarda shifts d'alineaci√≥ per cada SEQ COLUMN
        - Fallback: si no hi ha KHP, usa alignment de SEQ propera en el temps
        - Camps: timestamp, seq_name, seq_date, method, shifts, khp_file, details

[x] Integrar hpsec_consolidate.py a HPSEC_Suite.py
    - Substituir codi inline per import del m√≤dul
    - Eliminar funcions duplicades de la Suite

[!] IMPORTANT - CALIBRACI√ì afectada per origen DOC:
    - Si hi ha DUAL (Direct + UIB): usar Direct com a principal
    - Si nom√©s hi ha UIB (sense Direct): usar UIB com a fallback
    - AFECTA CALIBRACI√ì: els factors s√≥n diferents!
      * Direct: 0.82
      * UIB < SEQ 275: 0.84
      * UIB >= SEQ 275: 0.87
    - El camp DOC_MODE a ID indica l'origen usat (DUAL, UIB, DIRECT)
    - La Suite ha de llegir DOC_MODE per aplicar el factor correcte!

[x] hpsec_calibrate.py - M√≤dul calibraci√≥ standalone:
    - An√†lisi KHP: analizar_khp_consolidado, analizar_khp_lote
    - Cerca KHP: buscar_khp_consolidados (LOCAL ‚Üí SIBLINGS ‚Üí MANUAL)
    - Gesti√≥ historial: CALDATA local + KHP_History global
    - Registre: register_calibration, mark_calibration_as_outlier
    - Funci√≥ principal: calibrate_sequence(seq_path, config, callbacks)
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[ ] Considerar fusionar hpsec_utils i hpsec_core en un sol modul
    - Renombrar detect_batman per clarificar:
      * detect_peak_notch (artefactes BP)
      * detect_double_peak (pics coeluits columna)

--------------------------------------------------------------------------------
FILTRES IMPLEMENTATS (DOCtor_BP v1.7)
--------------------------------------------------------------------------------
[x] Bi-Gaussiana (sigma_left != sigma_right)
[x] Deteccio Batman (valls al cim del pic)
[x] Reparacio parabola amb factor 0.85
[x] Filtre R2 >= 0.98 per reparar (exclou pics escombraries)
[x] Filtre asimetria 0.33-3.0 (detecta errors detector DOC)
[x] Mostra R2 i dH abans/despres de reparacio

--------------------------------------------------------------------------------
LLINDARS ACTUALS
--------------------------------------------------------------------------------
THRESH_R2_VALID = 0.987      # R2 >= 0.987 -> VALID
THRESH_R2_CHECK = 0.980      # 0.980 <= R2 < 0.987 -> CHECK
REPAIR_MIN_R2 = 0.980        # No reparar si R2 < 0.98
ASYM_MIN = 0.33              # Asimetria minima acceptable
ASYM_MAX = 3.0               # Asimetria maxima acceptable
REPAIR_FACTOR = 0.85         # Factor correccio tangent

--------------------------------------------------------------------------------
ANOMALIES A REVISAR
--------------------------------------------------------------------------------
[!] 271_SEQ_BP - KHP ANOMAL (NO USAR PER CALIBRACIO/ALINEACIO)
    - KHP2_271_BP_R1: 4060 mAU
    - KHP2_271_BP_R2: 4140 mAU
    - Valors normals KHP2: 180-1000 mAU (mitjana ~450 mAU)
    - Valores 271 s√≥n 4-6x superiors al normal
    - EXCLOURE d'alineaci√≥ i calibraci√≥

[ ] KHP2_284_BP te altura anomalament alta (242 mAU) vs KHP2_277 (149) i KHP2_281 (183)
    - Mateixa concentracio, mateixa sensibilitat (UIB>=275)
    - Possible canvi de fungible DOC entre seq√º√®ncies?
    - Revisar historial de manteniment del detector

[ ] Implementar detecci√≥ anomalies KHP abans d'usar per alineaci√≥/calibraci√≥
    - Calcular mitjana i desviaci√≥ est√†ndard de tots els KHPs
    - Marcar com a outlier si valor > mitjana + 3*std
    - Afecta: calculate_column_alignment_shifts() a hpsec_consolidate.py
    - Afecta: calibrate_sequence() a hpsec_calibrate.py
    - Llista negra actual: 271_SEQ_BP

--------------------------------------------------------------------------------
NOTES
--------------------------------------------------------------------------------
- Directes son diferents de UIB
- UIB te canvi sensibilitat a seq 275 (700 ppb -> 1000 ppb)
- Factor calibracio: Directe=0.82, UIB<275=0.84, UIB>=275=0.87

--------------------------------------------------------------------------------
PENDENT - REVISIO FULL ID CONSOLIDATS
--------------------------------------------------------------------------------
[ ] Reestructurar fulla ID dels fitxers consolidats:
    - Esborrar full ID si existeix i crear des de zero
    - Camps d'identificaci√≥ (del mestre):
      * Date, SEQ, Mostra, Replica (extreure del fitxer mestre)
      * INJ_Volum (nou - s'afegir√† als mestres)
      * UIB_range (nou - s'afegir√† als mestres)
      * Fitxer_Mestre: nom del fitxer Excel origen
    - Method: auto-detect (COLUMN/BP) per√≤ permetre canvi manual
    - Mode: auto-detect (UIB/DIRECT/DUAL)
    - Camps de consolidaci√≥ (a definir)
    - UIB_Offset: raw/final + warning a columna C si cal
    - Camps de resultats: a definir posteriorment

    PROPOSTA: L'usuari crear√† Excel amb estructura proposada

[ ] JSON per SEQ amb detalls t√®cnics de transformaci√≥:
    - Offsets, shifts, baselines, etc.
    - Info que no cal a cada consolidat individual

--------------------------------------------------------------------------------
PENDENT - GESTIO OFFSET UIB (An√†lisi completada 2025-01-24)
--------------------------------------------------------------------------------
[ ] Implementar monitoratge offset UIB:
    - Offset normal: -3.637 min (¬±0.1s entre mostres)
    - Llindars:
      * OK: offset entre [-3.65, -3.62] min
      * WARNING: diff 0.015-0.1 min
      * ERROR: diff > 0.1 min
    - Anomalies detectades: 279B_SEQ (+35min), 283_SEQ FR2606_R1 (0.005)

[ ] Implementar alineaci√≥ DAD-DOC:
    - Corregir SEMPRE (eliminar toler√†ncia 2s actual)
    - Shift esperat: ~-0.5s (DAD-DOC)
    - Llindars:
      * OK: |shift + 0.5| < 1.5s
      * WARNING: 1.5s < |shift| < 5s
      * ERROR: |shift| > 5s
    - Cas 272_SEQ: KHP incorrecte (shift 40s) ‚Üí usar fallback

[ ] Protocol fallback quan KHP inv√†lid:
    - Usar SEQ anterior (BP o COLUMN, √©s igual per offset)
    - WARNING si SEQ anterior > 30 dies
    - ERROR si SEQ anterior > 90 dies

[ ] Documentaci√≥:
    - JSON per SEQ: detalls transformaci√≥
    - ID consolidat: UIB_Offset: raw/final + warning col C

--------------------------------------------------------------------------------
MASTERFILE - ESTRUCTURA CANONICA (Unificat 2025-01-24)
--------------------------------------------------------------------------------
[x] Estructura can√≤nica unificada per tots els MasterFiles:
    0-INFO:       Metadata + sincronitzaci√≥
                  - SEQ-ID, Date, Method (COLUMN/BP)
                  - Inj_Volume (100 BP, 400 COLUMN excepte 256-274)
                  - UIB_range: None (sense UIB), 700 ppb (269-274), 1000 ppb (>=275)
                  - Hora HPLC, Hora TOC, Desfase, Flush time, Net delay
    1-HPLC-SEQ:   Injeccions + Inj_Index + Sample_Rep
    2-TOC:        Dades DOC cont√≠nues (raw, intocable)
    3-DAD_KHP:    Dades DAD nom√©s de KHP (opcional, si n'hi ha)
    4-TOC_CALC:   C√†lculs (TOC_Row, Sample, Temps_Relatiu, Inj_Index) - SEMPRE AL FINAL

[x] M√≤dul migraci√≥: hpsec_migrate_master.py
    - Detecta Method per nom carpeta (_BP) o temps execuci√≥
    - Extreu KHP amb sufixos _R1, _R2 per m√∫ltiples r√®pliques
    - Crea backup autom√†tic abans de migrar
    - Suporta migraci√≥ individual o en lot (--all)

[x] M√≤dul unificaci√≥: hpsec_unify_masterfiles.py (NOU 2025-01-24)
    - Unifica tots els MasterFiles a l'estructura can√≤nica
    - Renombra fulls: TOC_CALC -> 4-TOC_CALC, DAD_KHP -> 3-DAD_KHP
    - Reordena: TOC_CALC sempre al final
    - Elimina fulls redundants (3-SEQ_DATA)
    - Afegeix Sample_Rep a 1-HPLC-SEQ si falta
    - Crea backup autom√†tic abans de modificar

    √ös:
      python hpsec_unify_masterfiles.py --scan        # Dry run
      python hpsec_unify_masterfiles.py --apply       # Aplicar canvis

    Estat unificaci√≥ (2025-01-24):
      - 38 fitxers MasterFile unificats
      - 29 amb estructura completa (amb 3-DAD_KHP)
      - 9 sense DAD_KHP (no tenien KHP)
      - Backups creats a cada carpeta SEQ

[ ] Actualitzar hpsec_consolidate.py per treballar amb nou MasterFile

================================================================================
REGISTRE DE SCRIPTS
================================================================================

Format: [DATA HORA] script.py - Descripci√≥ breu

[2026-01-26 xx:xx] hpsec_replica.py v1.2 - AVALUACI√ì DAD
    Single Source of Truth per avaluar i seleccionar r√®pliques.

    Funcions DOC:
      - evaluate_replica(t, y, method) - avalua qualitat (batman, timeout, irr, r2, snr)
      - select_best_replica(eval1, eval2, method, dad_eval) - selecciona millor
      - compare_replicas(t1, y1, t2, y2) - Pearson i difer√®ncia √†rea

    Funcions DAD (NOU):
      - evaluate_dad(t, y) - deriva, soroll, SNR per wavelength
      - evaluate_dad_multi(t, dad_data) - avalua A254, A280, etc.
      - compare_doc_dad(t_doc, y_doc, t_dad, y_dad) - correlaci√≥ DOC-DAD
      - compare_replicas_full(...) - comparaci√≥ completa DOC+DAD

    COLUMN (v1.2):
      1. Anomalies (Batman > Timeout > IRR)
      2. DAD quality (si POOR, descartar)
      3. SNR (si ratio > 1.5x)
      4. Pearson (warning < 0.990)
      5. √Ärea diff (warning > 15%)
      6. DAD drift (preferir menys deriva)
      7. Al√ßada (tiebreaker)

    BP:
      1. Batman
      2. R¬≤ status (VALID > CHECK > INVALID)
      3. R¬≤ valor (bi-gaussiana)
      4. SNR (tiebreaker)
      + Pearson/√Ärea/DAD generen warnings

    Usat per: DOCtor_C v1.3, DOCtor_BP v1.7, HPSEC_Suite

[2026-01-26 xx:xx] DOCtor_C.py v1.3 - USA HPSEC_REPLICA
    Integraci√≥ amb hpsec_replica.py per selecci√≥ de r√®pliques.
    - evaluate_replica() substitueix deteccions manuals
    - select_best_replica() importat de hpsec_replica
    - compare_replicas() per Pearson/√†rea

[2026-01-26 xx:xx] DOCtor_BP.py v1.7 - USA HPSEC_REPLICA
    Integraci√≥ amb hpsec_replica.py per selecci√≥ de r√®pliques.
    - select_best_replica() importat de hpsec_replica (m√®tode BP)
    - compare_replicas() per Pearson/√†rea
    - make_eval() helper per convertir analysis a format eval
    - Criteris BP: R¬≤ status > R¬≤ valor > SNR

[2026-01-26 xx:xx] DOCtor_C.py v1.2 - SIMPLIFICACI√ì DETECCI√ì
    Eliminades deteccions que no funcionen b√©:
    - detect_timeout() local (mesetes) -> ara usa hpsec_core.detect_timeout (dt intervals)
    - detect_ears() (orelletes) - ~95 l√≠nies
    - calc_monotonicity() - ~50 l√≠nies
    - detect_peak_problem() (Regla D) - ~35 l√≠nies
    Simplificat select_best_replica(): nom√©s Batman + Al√ßada
    Detecci√≥ final: Batman + IRR + Timeout (dt intervals hpsec_core)

[2026-01-26 23:30] DOCtor_C.py v1.1 - AMORPHOUS ELIMINAT
    Eliminada detecci√≥ amorphous (prec√†ria, molts FP).
    Eliminat: detect_amorphous(), detect_amorphous_on_peak(),
              validate_amorphous_with_replicates(), calc_smoothness()
    Total: ~685 l√≠nies eliminades (~757 l√≠nies netes)
    Detecci√≥ ara: timeout (dt intervals), batman, irregular

[2026-01-26 22:00] hpsec_consolidate.py - TIMEOUT DETECTION
    Afegida detecci√≥ autom√†tica de timeouts TOC per cad√®ncia dades.
    Noves funcions: detect_doc_timeouts(), format_timeout_status()
    Modificades: extract_doc_from_masterfile/master(), write_consolidated_excel()
    Output: TOC_Timeout_* camps al full ID dels consolidats
    Warnings: alertes durant consolidaci√≥ per timeouts en zona cr√≠tica

[2026-01-26 04:15] hpsec_migrate_master.py - UNIFICAT
    Creaci√≥ de MasterFiles des de rawdata v11/v12.
    API: migrate_single(), migrate_batch(), find_seq_folders()
    CLI: --all (totes), --list (llistar), <carpeta> (una)
    Integra: regenerate_toc_calc.py + hpsec_unify_masterfiles.py (eliminats)

[2025-01-24 23:45] hpsec_consolidate.py - Consolidaci√≥ SEQ
    Llegeix MasterFile + Export3D, genera fitxers consolidats.
    Suporta DUAL (Direct+UIB), COLUMN i BP.

[2025-01-24 23:25] hpsec_unify_masterfiles.py - ELIMINAT (integrat a migrate_master)
    Unificava estructura de fulls a format can√≤nic.

[2025-01-24] regenerate_toc_calc.py - ELIMINAT (integrat a migrate_master)
    Regenerava full 4-TOC_CALC amb Sample mapping.

[2026-01-26 xx:xx] HPSEC_Suite.py - USA HPSEC_REPLICA
    _evaluate_replica() ara usa evaluate_replica_unified de hpsec_replica.
    Funcions locals detect_timeout, detect_batman, detect_ears marcades DEPRECATED.
    _select_best_replica() simplificat (eliminat n_ears comparison).

[2025-01-xx] hpsec_calibrate.py - Calibraci√≥ KHP
    An√†lisi KHP, cerca autom√†tica, gesti√≥ historial CALDATA.

[2025-01-xx] hpsec_replica.py - Selecci√≥ de r√®pliques
    Single Source of Truth: evaluate_replica, select_best_replica, compare_replicas

[2025-01-xx] hpsec_reports.py - Generaci√≥ PDFs
    Reports consolidaci√≥ i cromatogrames.

[2025-01-xx] hpsec_core.py - Funcions matem√†tiques
    Bi-gaussiana, detecci√≥ batman, reparaci√≥ par√†bola, SNR, R¬≤.

[2025-01-xx] hpsec_utils.py - Utilitats generals
    Baseline, detecci√≥ pics, normalitzaci√≥, helpers GUI.

[2025-01-xx] analyze_khp_alignment.py - An√†lisi alineaci√≥ KHP (WIP)
    Compara shift DAD vs DOC per verificar FLUSH_TIME.

================================================================================

Revisio de Doctor_C

[RESOLT 2026-01-26] EX1L2503_258 R1 Amorphous OK R2 Amorphous per ra√≥ incorrecte.
  - Detecci√≥ amorphous era prec√†ria i generava molts falsos positius
  - SOLUCI√ì: Eliminada detecci√≥ amorphous a DOCtor_C v1.1
  - Ara s'utilitza nom√©s timeout via dt intervals (m√©s robust)

================================================================================
CHANGELOG / HISTORIAL D'ACCIONS
================================================================================

2026-01-26 - NETEJA HPSEC_Suite.py
--------------------------------------------------------------------------------
[DARRERA ACCIO]

Eliminades funcions duplicades i deprecated (~450 l√≠nies):

FUNCIONS ELIMINADES (importades de m√≤duls):
  - llegir_doc_uib, llegir_dad_export3d ‚Üí hpsec_consolidate
  - netejar_nom_uib, trobar_excel_mestre ‚Üí hpsec_consolidate
  - extract_doc_from_master, process_dad ‚Üí hpsec_consolidate
  - baseline_stats ‚Üí hpsec_utils
  - baseline_stats_time ‚Üí hpsec_calibrate
  - detect_main_peak ‚Üí hpsec_consolidate
  - netejar_baseline (duplicat) ‚Üí eliminat

FUNCIONS DEPRECATED ELIMINADES:
  - detect_batman ‚Üí usar hpsec_replica.evaluate_replica()
  - detect_timeout ‚Üí usar hpsec_replica.evaluate_replica()
  - detect_ears ‚Üí no funcionava, eliminat

IMPORTS AFEGITS:
  - from hpsec_utils import baseline_stats
  - from hpsec_replica import evaluate_dad, evaluate_dad_multi, compare_doc_dad

Resultat: 7244 l√≠nies ‚Üí 6793 l√≠nies (-451 l√≠nies, -6%)

PENDENT:
  - avaluar_qualitat_dad_replica() i seleccionar_millor_dad() podrien
    migrar a hpsec_replica per√≤ requereixen m√©s refactoring

--------------------------------------------------------------------------------

2026-01-26 - SIMPLIFICACI√ì DETECCI√ì (DOCtor_C v1.2)
--------------------------------------------------------------------------------

Objectiu: Mantenir nom√©s les deteccions que funcionen b√©.

Problema:
  - detect_timeout() local (mesetes) era molt sensible a falsos positius
  - detect_ears() no funcionava b√© en la pr√†ctica
  - calc_monotonicity() i detect_peak_problem() (Regla D) no aporten valor
  - El m√®tode dt intervals de hpsec_core √©s molt m√©s robust per timeouts

Accions realitzades:
  1. Creat branch refactor/simplify-doctorc-detection
  2. Eliminades funcions:
     - detect_timeout() local (mesetes) - ~145 l√≠nies
     - detect_ears() - ~95 l√≠nies
     - calc_monotonicity() - ~50 l√≠nies
     - detect_peak_problem() (Regla D) - ~35 l√≠nies
  3. Eliminats camps: has_stop, stop_cv, stop_info, mono_*, ears
  4. Actualitzat detect_timeout a usar hpsec_core.detect_timeout (dt intervals)
  5. Simplificat select_best_replica(): nom√©s Batman + Al√ßada
  6. Actualitzat docstring a v1.2 amb changelog

Resultat:
  - DOCtor_C.py ara ~1550 l√≠nies (abans ~1900 v1.1)
  - Detecci√≥ molt m√©s simple i robusta:
    * Batman (via detect_peak_anomaly)
    * IRR (smoothness < 18% via detect_peak_anomaly)
    * Timeout (via hpsec_core.detect_timeout - dt intervals)

--------------------------------------------------------------------------------

2026-01-26 - ELIMINACI√ì DETECCI√ì AMORPHOUS (DOCtor_C v1.1)
--------------------------------------------------------------------------------

Objectiu: Simplificar DOCtor_C eliminant detecci√≥ amorphous prec√†ria.

Problema:
  - detect_amorphous() generava molts falsos positius
  - Algoritme complex (segments lineals + angles) massa sensible
  - validate_amorphous_with_replicates() afegia complexitat sense benefici
  - Timeout via dt intervals √©s molt m√©s robust i fiable

Accions realitzades:
  1. Creat branch refactor/remove-amorphous-column
  2. Eliminades funcions (~685 l√≠nies):
     - detect_amorphous() - ~370 l√≠nies
     - detect_amorphous_on_peak() - ~70 l√≠nies
     - validate_amorphous_with_replicates() - ~190 l√≠nies
     - calc_smoothness() - ~55 l√≠nies
  3. Eliminats camps: is_amorphous, amorphous_info, amorphous_angles, n_amorphous
  4. Eliminada visualitzaci√≥ AMORPHOUS (text box, labels)
  5. Simplificat has_issues: ara is_anomaly OR has_stop OR mono_total < llindar
  6. Actualitzat docstring a v1.1 amb changelog
  7. Commit i merge a main

Resultat:
  - Net: 789 l√≠nies eliminades, 32 insercions
  - DOCtor_C.py ara ~1900 l√≠nies (abans ~2650)
  - Detecci√≥ m√©s robusta i menys falsos positius

Detecci√≥ ara basada en:
  - Timeout via dt intervals (primari)
  - Batman (pic-vall-pic al cim)
  - Irregular (smoothness < 18% via detect_peak_anomaly)

--------------------------------------------------------------------------------

2026-01-26 - ANALISI IMPACTE TIMEOUT TOC (COMPLETAT)
--------------------------------------------------------------------------------

Objectiu: Quantificar l'impacte real dels timeouts en la qualitat de les dades.

An√†lisi realitzada (331 mostres DUAL: 178 Column + 153 BP):
  - Mostres amb timeout: 198 (60%)
  - CRITICAL (zona HS): 11
  - WARNING (BioP/BB/SB): 109
  - INFO (LMW/post-run): 78

Resultats principals:
  - Pearson Direct vs UIB global: 0.988-0.993 (excel¬∑lent)
  - Zona HS (m√©s sensible): r = 0.983
  - Els timeouts NO invaliden les dades

Durada zona afectada (RMSE analysis):
  - PRE-timeout: ~0.5 min (RMSE elevat 41%)
  - Timeout: ~1.2 min (74s gap)
  - POST-timeout: ~1.0 min (estabilitzaci√≥)
  - TOTAL: ~2.5-3 min afectats

Fitxers generats:
  - PROVES/timeout_impact/all_samples_v3.pdf (331 p√†gines, totes les mostres)
  - PROVES/timeout_impact/informe_timeout_resum.png
  - PROVES/timeout_impact/informe_timeout_perfil.png
  - PROVES/timeout_impact/informe_timeout_duracio.png
  - PROVES/timeout_impact/timeout_impact_metrics.csv

--------------------------------------------------------------------------------

2026-01-26 - DETECCIO TIMEOUTS TOC

Objectiu: Detectar autom√†ticament els timeouts per rec√†rrega de xeringues TOC
         i avisar quan afecten zones cr√≠tiques del cromatograma.

An√†lisi pr√®via:
  - Cicle rec√†rrega: 77.2 min (verificat amb 6 seq√º√®ncies)
  - Timeout: ~74 segons
  - Durada mostra: 78.65 min (constant, CV=0.013%)
  - Deriva: 1.45 min per mostra (el timeout "retrocedeix")
  - Model predictiu: r = 0.9982, error mitj√† 1.2%

Implementaci√≥ a hpsec_consolidate.py (+426 l√≠nies):
  1. TIMEOUT_CONFIG - Configuraci√≥ zones i severitats
  2. detect_doc_timeouts() - Detecta timeouts per cad√®ncia (dt > 60s)
  3. format_timeout_status() - Formata estat per consolidat
  4. extract_doc_from_masterfile() - Ara retorna (df, timeout_info)
  5. extract_doc_from_master() - Ara retorna (df, timeout_info)
  6. write_consolidated_excel() - Nou par√†metre timeout_info
  7. Actualitzades totes les crides a funcions d'extracci√≥

Severitats per zona:
  - CRITICAL: HS (18-23 min) - Zona subst√†ncies h√∫miques
  - WARNING: BioP, BB, SB (0-40 min) - Zones cr√≠tiques
  - INFO: LMW (40-70 min), RUN_START (<1 min)
  - OK: POST_RUN (>70 min) - Zona ideal

Output al full ID:
  TOC_Timeout_Detected, TOC_Timeout_Count, TOC_Timeout_Severity,
  TOC_Timeout_N (detalls), TOC_Zones_Affected, TOC_Dt_Median/Max_sec

Documentaci√≥ generada:
  - PROVES/dual_profiles/OPTIMITZACIO_SEQUENCIES_TOC.md
  - PROVES/dual_profiles/MODEL_PREDICTIU_TIMEOUT.md
  - PROVES/dual_profiles/analisi_completa_T0.png

Recomanaci√≥ operativa:
  Si es canvia durada mostra a 77.2 min + espera 3-5 min post-flush:
  ‚Üí 100% timeouts en zona post-run (sense impacte)

--------------------------------------------------------------------------------

2025-01-24 - UNIFICACIO MASTERFILES
--------------------------------------------------------------------------------

Objectiu: Unificar l'estructura de tots els MasterFiles existents a Dades2

Problema detectat:
  - 4 variants d'estructura diferents
  - Noms de fulls inconsistents (TOC_CALC vs 3-TOC_CALC vs 4-TOC_CALC)
  - Ordre de fulls variable (TOC_CALC abans o despr√©s de DAD_KHP)
  - 2 fitxers amb 3-SEQ_DATA redundant

Accions realitzades:
  1. An√†lisi de 38 MasterFiles per identificar variants
  2. Definici√≥ estructura can√≤nica:
     0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP (opcional), 4-TOC_CALC (sempre al final)
  3. Creaci√≥ hpsec_unify_masterfiles.py
  4. Execuci√≥ unificaci√≥ amb --apply (38 fitxers processats)
  5. Regeneraci√≥ 4-TOC_CALC per 265_SEQ i 277_SEQ_BP (no en tenien)

Resultat:
  - 29 fitxers: 0-INFO, 1-HPLC-SEQ, 2-TOC, 3-DAD_KHP, 4-TOC_CALC
  - 9 fitxers:  0-INFO, 1-HPLC-SEQ, 2-TOC, 4-TOC_CALC (sense KHP)
  - Backups creats a cada carpeta (*_backup_YYYYMMDD_HHMMSS.xlsx)

Fitxers nous/modificats:
  - hpsec_unify_masterfiles.py (NOU)
  - 38 MasterFiles a Dades2/ (MODIFICATS)
  - 38 backups creats 