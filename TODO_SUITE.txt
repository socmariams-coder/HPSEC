================================================================================
TODO - SUITE HPSEC
================================================================================

[x] CONSOLIDACIO: Verificar fitxers (IMPLEMENTAT)
    - Al consolidar, comptar quants fitxers hi ha al directori origen
    - Comptar quants s'han utilitzat/processat
    - Alertar si hi ha discrepancia (ex: R12 en lloc de R2, fitxers orfes, etc.)
    - Cas detectat: FR2395_273_BP tenia R1 i R12 (error nomenclatura)

    [x] Detecció discrepàncies a hpsec_consolidate.py:
        - Retorna files_found, files_used, files_orphan al result["file_check"]
        - Detecta anomalies nomenclatura (R12 → R2)
        - Genera proposed_renames amb raó i confiança
        - Guarda a HPSEC_QAQC/File_Check_[SEQ].json si hi ha problemes
        - Funció apply_renames() preparada per aplicar canvis

    [ ] GUI per gestionar renames (quan s'integri a Suite):
        - Taula amb Original | Proposta | Acció
        - Opcions: Rename / Ignorar / Editar manualment
        - Botó aplicar canvis

--------------------------------------------------------------------------------
ORGANITZACIO CODI
--------------------------------------------------------------------------------
[x] hpsec_core.py - Funcions compartides BP:
    - bigaussian, fit_bigaussian, check_asymmetry
    - detect_batman (artefactes al cim del pic)
    - repair_with_parabola, find_tangents_and_anchors
    - calc_snr, calc_peak_area, calc_pearson, calibrate_factor
    - Constants globals (THRESH_R2_*, REPAIR_*, ASYM_*)

[x] hpsec_utils.py - Utilitats generals:
    - baseline_stats, detect_main_peak
    - detect_batman (pics dobles coeluits - columna)
    - seleccionar_carpeta, obtenir_seq, normalize_key
    - is_khp, extract_khp_conc

[x] hpsec_reports.py - Mòdul generació PDFs professional:
    - generate_consolidation_report(): Resum + taula punts Direct/UIB/DAD
    - generate_chromatograms_report(): Rèpliques R1|R2 juntes, ordenat
    - Ordenació: Mostres → KHP → Controls (MQ/NaOH)
    - Format científic: logo, capçalera minimalista, peu de pàgina
    - 4 parells per pàgina, eixos etiquetats
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[x] hpsec_consolidate.py - Mòdul consolidació extret de Suite:
    - Funcions lectura: llegir_doc_uib, llegir_dad_export3d, trobar_excel_mestre
    - Funcions processament: process_dad, detect_main_peak, analyze_sample_areas
    - Funció principal: consolidate_sequence(seq_path, config, progress_callback)
    - Funció escriptura: write_consolidated_excel()
    [x] DUAL PROTOCOL: Extreu DOC de UIB (CSV) i Direct (Excel mestre)
        - Output: time, DOC (Direct), DOC_UIB
        - Escala temps: Direct (~4 sec, real) vs UIB (~0.32 sec, fictícia)
    [x] ALINEACIÓ:
        - BP: Alinea pel màxim de cada mostra individualment
        - COLUMN: Alinea amb KHP + A254 com a referència
    [x] LOG QAQC (HPSEC_QAQC/Alignment_History.json):
        - Guarda shifts d'alineació per cada SEQ COLUMN
        - Fallback: si no hi ha KHP, usa alignment de SEQ propera en el temps
        - Camps: timestamp, seq_name, seq_date, method, shifts, khp_file, details

[x] Integrar hpsec_consolidate.py a HPSEC_Suite.py
    - Substituir codi inline per import del mòdul
    - Eliminar funcions duplicades de la Suite

[!] IMPORTANT - CALIBRACIÓ afectada per origen DOC:
    - Si hi ha DUAL (Direct + UIB): usar Direct com a principal
    - Si només hi ha UIB (sense Direct): usar UIB com a fallback
    - AFECTA CALIBRACIÓ: els factors són diferents!
      * Direct: 0.82
      * UIB < SEQ 275: 0.84
      * UIB >= SEQ 275: 0.87
    - El camp DOC_MODE a ID indica l'origen usat (DUAL, UIB, DIRECT)
    - La Suite ha de llegir DOC_MODE per aplicar el factor correcte!

[x] hpsec_calibrate.py - Mòdul calibració standalone:
    - Anàlisi KHP: analizar_khp_consolidado, analizar_khp_lote
    - Cerca KHP: buscar_khp_consolidados (LOCAL → SIBLINGS → MANUAL)
    - Gestió historial: CALDATA local + KHP_History global
    - Registre: register_calibration, mark_calibration_as_outlier
    - Funció principal: calibrate_sequence(seq_path, config, callbacks)
    [x] Integrar a HPSEC_Suite.py (substituir funcions actuals)

[ ] Considerar fusionar hpsec_utils i hpsec_core en un sol modul
    - Renombrar detect_batman per clarificar:
      * detect_peak_notch (artefactes BP)
      * detect_double_peak (pics coeluits columna)

--------------------------------------------------------------------------------
FILTRES IMPLEMENTATS (DOCtor_BP v1.6)
--------------------------------------------------------------------------------
[x] Bi-Gaussiana (sigma_left != sigma_right)
[x] Deteccio Batman (valls al cim del pic)
[x] Reparacio parabola amb factor 0.85
[x] Filtre R2 >= 0.98 per reparar (exclou pics escombraries)
[x] Filtre asimetria 0.33-3.0 (detecta errors detector DOC)
[x] Mostra R2 i dH abans/despres de reparacio

--------------------------------------------------------------------------------
LLINDARS ACTUALS
--------------------------------------------------------------------------------
THRESH_R2_VALID = 0.987      # R2 >= 0.987 -> VALID
THRESH_R2_CHECK = 0.980      # 0.980 <= R2 < 0.987 -> CHECK
REPAIR_MIN_R2 = 0.980        # No reparar si R2 < 0.98
ASYM_MIN = 0.33              # Asimetria minima acceptable
ASYM_MAX = 3.0               # Asimetria maxima acceptable
REPAIR_FACTOR = 0.85         # Factor correccio tangent

--------------------------------------------------------------------------------
ANOMALIES A REVISAR
--------------------------------------------------------------------------------
[ ] KHP2_284_BP te altura anomalament alta (242 mAU) vs KHP2_277 (149) i KHP2_281 (183)
    - Mateixa concentracio, mateixa sensibilitat (UIB>=275)
    - Possible canvi de fungible DOC entre seqüències?
    - Revisar historial de manteniment del detector

--------------------------------------------------------------------------------
NOTES
--------------------------------------------------------------------------------
- Directes son diferents de UIB
- UIB te canvi sensibilitat a seq 275 (700 ppb -> 1000 ppb)
- Factor calibracio: Directe=0.82, UIB<275=0.84, UIB>=275=0.87

================================================================================

Revisio de Doctor_C

EX1L2503_258 R1 Amorphous OK R2 Amorphous per raó incorrecte. Ho es per la base a la pujada, no pel màxim del pic. 